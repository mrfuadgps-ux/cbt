<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Sekolah - Login</title>
    <style>
        /* SIMPLE CSS */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 400px;
        }
        .login-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo h1 {
            color: #2575fc;
            font-size: 24px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #1a68e8;
        }
        .demo {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 14px;
        }
        .demo h4 {
            margin-bottom: 10px;
            color: #333;
        }
        .demo div {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .demo div:hover {
            background: #e8e8e8;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 12px;
        }
        .hidden { display: none; }
        #message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .info { background: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-box">
            <div class="logo">
                <h1>CBT Sekolah</h1>
                <p>Sistem Computer Based Test</p>
            </div>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="masukan email" value="siswa1@sekolah.com">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="masukan password" value="siswa123">
                </div>
                
                <div class="form-group">
                    <label>Login Sebagai</label>
                    <select id="role">
                        <option value="siswa">Siswa</option>
                        <option value="guru">Guru</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <button id="loginBtn">Masuk</button>
                
                <div class="demo">
                    <h4>Akun Demo:</h4>
                    <div onclick="fillCredentials('siswa1@sekolah.com', 'siswa123', 'siswa')">
                        Siswa: siswa1@sekolah.com / siswa123
                    </div>
                    <div onclick="fillCredentials('guru1@sekolah.com', 'guru123', 'guru')">
                        Guru: guru1@sekolah.com / guru123
                    </div>
                    <div onclick="fillCredentials('admin@sekolah.com', 'admin123', 'admin')">
                        Admin: admin@sekolah.com / admin123
                    </div>
                </div>
            </div>
            
            <div id="loading" class="hidden">
                <p>Sedang memproses...</p>
            </div>
            
            <div class="footer">
                <p>¬© 2026 CBT Sekolah v3.0.0</p>
                <p id="apiStatus">Mengecek API...</p>
            </div>
        </div>
    </div>
    
    <div id="message" class="hidden"></div>

        <script>
        // URL BARU YANG BEKERJA!
        const API_URL = "https://script.google.com/macros/s/AKfycbyiKTuWbMtzBcg0KjFixUaIvhSkVmllHpG5qCrS3UB0OUk5kFznS1A2kb-7CJ1GDXf0YA/exec";
        
        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const roleSelect = document.getElementById('role');
        const loginForm = document.getElementById('loginForm');
        const loadingDiv = document.getElementById('loading');
        const apiStatusText = document.getElementById('apiStatus');
        
        // Simple message function
        function showMessage(text, type = 'info') {
            // Remove existing message
            const oldMsg = document.getElementById('message');
            if (oldMsg) oldMsg.remove();
            
            // Create new message
            const msg = document.createElement('div');
            msg.id = 'message';
            msg.textContent = text;
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;
            
            if (type === 'success') {
                msg.style.background = 'linear-gradient(to right, #4CAF50, #45a049)';
            } else if (type === 'error') {
                msg.style.background = 'linear-gradient(to right, #f44336, #d32f2f)';
            } else {
                msg.style.background = 'linear-gradient(to right, #2196F3, #1976D2)';
            }
            
            document.body.appendChild(msg);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (msg.parentNode) {
                    msg.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => msg.remove(), 300);
                }
            }, 3000);
        }
        
        // JSONP Login Function
        function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                showMessage('Email dan password harus diisi', 'error');
                return;
            }
            
            // Show loading
            loginForm.style.display = 'none';
            loadingDiv.style.display = 'block';
            
            // Generate unique callback name
            const callbackName = 'cbtLoginCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2);
            
            // Create callback function
            window[callbackName] = function(response) {
                console.log('Login response:', response);
                
                // Clean up
                delete window[callbackName];
                
                if (response && response.success) {
                    // LOGIN BERHASIL!
                    showMessage(`üéâ Login berhasil! Selamat datang ${response.data.nama}`, 'success');
                    
                    // Update API status
                    apiStatusText.textContent = 'API Online ‚úì';
                    apiStatusText.style.color = '#4CAF50';
                    
                    // Show success dashboard
                    setTimeout(() => {
                        showDashboard(response.data);
                    }, 1500);
                    
                } else {
                    showMessage(response.error || 'Login gagal', 'error');
                    loginForm.style.display = 'block';
                    loadingDiv.style.display = 'none';
                }
            };
            
            // Create JSONP script tag
            const script = document.createElement('script');
            const encodedEmail = encodeURIComponent(email);
            const encodedPassword = encodeURIComponent(password);
            
            script.src = `${API_URL}?callback=${callbackName}&action=login&email=${encodedEmail}&password=${encodedPassword}`;
            
            // Error handling
            script.onerror = function() {
                console.error('JSONP failed');
                delete window[callbackName];
                showMessage('Gagal terhubung ke server', 'error');
                loginForm.style.display = 'block';
                loadingDiv.style.display = 'none';
            };
            
            // Add to page
            document.head.appendChild(script);
        }
        
        // Dashboard after login
        function showDashboard(userData) {
            document.body.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(20px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .dashboard {
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 40px 20px;
                        animation: fadeIn 0.5s ease-out;
                    }
                    .header {
                        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
                        color: white;
                        padding: 40px;
                        border-radius: 20px;
                        margin-bottom: 30px;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                    }
                    .user-card {
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        margin-bottom: 30px;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                    }
                    .menu-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 30px;
                    }
                    .menu-btn {
                        padding: 20px;
                        background: white;
                        border: none;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                        transition: all 0.3s;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                    }
                    .menu-btn:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                    }
                    .menu-btn.siswa { border-left: 5px solid #4CAF50; }
                    .menu-btn.guru { border-left: 5px solid #2196F3; }
                    .menu-btn.admin { border-left: 5px solid #9C27B0; }
                    .logout-btn {
                        margin-top: 30px;
                        padding: 15px 30px;
                        background: #f44336;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: bold;
                        cursor: pointer;
                    }
                </style>
                
                <div class="dashboard">
                    <div class="header">
                        <h1>üéì CBT Sekolah Dashboard</h1>
                        <p>Sistem Computer Based Test v3.0</p>
                    </div>
                    
                    <div class="user-card">
                        <h2>üëã Selamat Datang, ${userData.nama}!</h2>
                        <p><strong>Role:</strong> ${userData.role.toUpperCase()}</p>
                        <p><strong>Email:</strong> ${userData.email}</p>
                        <p><strong>Kelas:</strong> ${userData.kelas || 'Tidak tersedia'}</p>
                        <p><strong>Login Time:</strong> ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                    
                    <h3>üìã Menu Utama:</h3>
                    <div class="menu-grid">
                        ${userData.role === 'siswa' ? `
                            <button class="menu-btn siswa" onclick="getUjianAktif('${userData.kelas}')">
                                üìù Lihat Ujian Aktif
                            </button>
                            <button class="menu-btn siswa" onclick="showMockUjian()">
                                üß™ Kerjakan Ujian
                            </button>
                            <button class="menu-btn siswa" onclick="showHasil()">
                                üìä Lihat Hasil
                            </button>
                        ` : ''}
                        
                        ${userData.role === 'guru' ? `
                            <button class="menu-btn guru" onclick="uploadSoal()">
                                üì§ Upload Soal
                            </button>
                            <button class="menu-btn guru" onclick="buatUjian()">
                                üìã Buat Ujian Baru
                            </button>
                            <button class="menu-btn guru" onclick="lihatHasilSiswa()">
                                üë®‚Äçüéì Lihat Hasil Siswa
                            </button>
                        ` : ''}
                        
                        ${userData.role === 'admin' ? `
                            <button class="menu-btn admin" onclick="manageUsers()">
                                üë• Manage Users
                            </button>
                            <button class="menu-btn admin" onclick="systemSettings()">
                                ‚öôÔ∏è System Settings
                            </button>
                            <button class="menu-btn admin" onclick="viewLogs()">
                                üìä View Logs
                            </button>
                        ` : ''}
                        
                        <button class="menu-btn" onclick="testAPIConnection()">
                            üîó Test API Connection
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="logout-btn" onclick="location.reload()">
                            üö™ Logout
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
                        <p>Backend API: <span style="color: #4CAF50; font-weight: bold;">ONLINE ‚úì</span></p>
                        <p>URL: ${API_URL}</p>
                    </div>
                </div>
            `;
            
            // Attach functions to window
            window.getUjianAktif = function(kelas) {
                const callbackName = 'cbtUjianCallback_' + Date.now();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    if (response.success) {
                        alert(`Ujian ditemukan: ${response.data.length}\n${JSON.stringify(response.data, null, 2)}`);
                    } else {
                        alert('Error: ' + response.error);
                    }
                };
                
                const script = document.createElement('script');
                script.src = `${API_URL}?callback=${callbackName}&action=getUjianAktif&kelas=${encodeURIComponent(kelas)}`;
                document.head.appendChild(script);
            };
            
            window.showMockUjian = function() {
                alert('Fitur ujian akan segera tersedia!');
            };
            
            window.testAPIConnection = function() {
                const callbackName = 'cbtTestCallback_' + Date.now();
                
                window[callbackName] = function(response) {
                    delete window[callbackName];
                    alert(`API Test: ${response.success ? 'SUCCESS üëç' : 'FAILED üëé'}`);
                };
                
                const script = document.createElement('script');
                script.src = `${API_URL}?callback=${callbackName}`;
                document.head.appendChild(script);
            };
        }
        
        // Fill demo credentials
        function fillCredentials(email, password, role) {
            emailInput.value = email;
            passwordInput.value = password;
            roleSelect.value = role;
            showMessage('Akun demo diisi otomatis', 'info');
        }
        
        // Check API status
        function checkAPIStatus() {
            const callbackName = 'cbtStatusCallback_' + Date.now();
            
            window[callbackName] = function(response) {
                delete window[callbackName];
                if (response && response.message) {
                    apiStatusText.textContent = 'API Online ‚úì';
                    apiStatusText.style.color = '#4CAF50';
                } else {
                    apiStatusText.textContent = 'API Offline ‚úó';
                    apiStatusText.style.color = '#f44336';
                }
            };
            
            const script = document.createElement('script');
            script.src = `${API_URL}?callback=${callbackName}`;
            script.onerror = function() {
                delete window[callbackName];
                apiStatusText.textContent = 'API Offline ‚úó';
                apiStatusText.style.color = '#f44336';
            };
            
            document.head.appendChild(script);
        }
        
        // Event Listeners
        loginBtn.addEventListener('click', handleLogin);
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
        // Auto-select role
        emailInput.addEventListener('blur', () => {
            const email = emailInput.value.trim().toLowerCase();
            if (email.includes('siswa')) roleSelect.value = 'siswa';
            else if (email.includes('guru')) roleSelect.value = 'guru';
            else if (email.includes('admin')) roleSelect.value = 'admin';
        });
        
        // Demo accounts click
        document.addEventListener('DOMContentLoaded', () => {
            checkAPIStatus();
            
            document.querySelectorAll('.account-list div').forEach(account => {
                account.style.cursor = 'pointer';
                
                account.addEventListener('click', () => {
                    const text = account.textContent;
                    const match = text.match(/(\w+):\s*([^\/]+)\/(.+)/);
                    if (match) {
                        const [, role, email, password] = match;
                        fillCredentials(email.trim(), password.trim(), role.toLowerCase());
                    }
                });
            });
            
            // Auto-fill for quick testing
            setTimeout(() => {
                if (!emailInput.value) {
                    fillCredentials('siswa1@sekolah.com', 'siswa123', 'siswa');
                }
            }, 500);
        });
    </script>
</body>
</html>
