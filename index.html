<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem CBT Sekolah</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
    #app { height: 100%; width: 100%; }
    .sidebar-item:hover { background: rgba(255,255,255,0.1); }
    .sidebar-item.active { background: rgba(255,255,255,0.15); border-left: 3px solid #fff; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-primary { transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-1px); }
    .toast { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .polling-indicator { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    .modal-overlay { animation: fadeIn 0.2s ease-out; }
    .modal-content { animation: slideIn 0.3s ease-out; }
    .delete-pending { background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes sending { 0%, 100% { transform: translateY(0); opacity: 0.6; } 50% { transform: translateY(-8px); opacity: 1; } }
    .sending-dots span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin: 0 4px; animation: sending 1.4s infinite; background: currentColor; }
    .sending-dots span:nth-child(1) { animation-delay: 0s; }
    .sending-dots span:nth-child(2) { animation-delay: 0.2s; }
    .sending-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse-circle { 0%, 100% { transform: scale(1); opacity: 0.3; } 50% { transform: scale(1.1); opacity: 0.6; } }
    .pulse-icon { animation: pulse-circle 2s infinite; }
    .dark { background-color: #1a202c; color: #e2e8f0; }
    .dark .bg-white { background-color: #2d3748; }
    .dark .bg-slate-50 { background-color: #4a5568; }
    .dark .text-slate-700 { color: #e2e8f0; }
    .dark .text-slate-500 { color: #a0aec0; }
    .dark .border-slate-200 { border-color: #4a5568; }
  </style>
</head>
<body class="h-full bg-slate-50">
  <div id="app" class="h-full w-full"></div>

  <script>
    // ==================== CONFIGURASI UTAMA ====================
    const CONFIG = {
      school_name: 'SMA Negeri 1 Contoh',
      school_year: '2024/2025',
      primary_color: '#1e40af',
      secondary_color: '#3b82f6',
      accent_color: '#10b981',
      text_color: '#1e293b',
      bg_color: '#f8fafc',
      sheet_id: '1VYQM3OzqC7zEexCU5-AiCttUjdBC7qmo_H0ugl4jbHA',
      script_url: 'https://script.google.com/macros/s/AKfycbzLZFz4WU5VKT34u146Wf1XAuwmlZqt8ia3d06mnd5yvWTfrUbXUPbNg1enpinjnsYG/exec'
    };

    // ==================== STATE GLOBAL ====================
    let currentUser = null;
    let currentView = 'login';
    let currentSubView = 'dashboard';
    let currentExam = null;
    let currentQuestion = null;
    let examAnswers = {};
    let examTimeLeft = 0;
    let examTimer = null;
    let pollingInterval = null;
    let deleteConfirmQueue = {};
    let batchSubmittedCount = 0;
    let currentQuestionIndex = 0;
    let submittedBatches = new Set();
    let isSubmittingBatch = false;
    let isSubmittingExam = false;

    // Data storage
    const DATA = {
      users: [], exams: [], questions: [], answers: [], results: [],
      _selectedExamId: null,
      _cache: {
        users: { data: [], timestamp: 0, ttl: 300000 },
        exams: { data: [], timestamp: 0, ttl: 300000 },
        questions: { data: [], timestamp: 0, ttl: 300000 },
        answers: { data: [], timestamp: 0, ttl: 60000 },
        results: { data: [], timestamp: 0, ttl: 60000 }
      }
    };

    // ==================== UTILITAS UMUM ====================
    function generateUUID(prefix = '') {
      return prefix + Date.now() + Math.random().toString(36).substr(2, 9);
    }

    function validateInput(input, type) {
      const patterns = {
        username: /^[a-zA-Z0-9_]{3,20}$/,
        password: /^.{6,}$/,
        email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        number: /^\d+$/,
        text: /^.{1,500}$/
      };
      return patterns[type] ? patterns[type].test(input) : true;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function getStatusBadge(status) {
      const badges = {
        'scheduled': '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">Terjadwal</span>',
        'active': '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">Berlangsung</span>',
        'completed': '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">Selesai</span>',
        'graded': '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">Dinilai</span>',
        'submitted': '<span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-medium">Dikumpulkan</span>'
      };
      return badges[status] || `<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded-full text-xs">${status}</span>`;
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ==================== NOTIFIKASI ====================
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast-container');
      if (existing) existing.remove();

      const colors = {
        success: { bg: 'bg-emerald-500', icon: '‚úì' },
        error: { bg: 'bg-red-500', icon: '‚úï' },
        info: { bg: 'bg-blue-500', icon: '‚Ñπ' },
        warning: { bg: 'bg-yellow-500', icon: '‚ö†' }
      };

      const { bg, icon } = colors[type] || colors.info;

      const toast = document.createElement('div');
      toast.className = 'toast-container fixed top-4 right-4 z-50';
      toast.innerHTML = `
        <div class="toast ${bg} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
          <span class="text-lg">${icon}</span>
          <span class="font-medium">${message}</span>
        </div>
      `;
      
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ==================== GOOGLE SHEETS API ====================
    async function fetchFromSheet(sheetName) {
      try {
        const cache = DATA._cache[sheetName];
        const now = Date.now();
        
        if (cache && cache.data.length > 0 && (now - cache.timestamp) < cache.ttl) {
          return cache.data;
        }
        
        const url = `${CONFIG.script_url}?action=readAll&sheet=${sheetName}`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const data = Array.isArray(result) ? result : (result?.data || []);
        
        cache.data = data;
        cache.timestamp = now;
        
        console.log(`‚úì ${sheetName}: ${data.length} records`);
        return data;
      } catch (error) {
        console.error(`‚úó ${sheetName}:`, error);
        return DATA._cache[sheetName]?.data || [];
      }
    }

    async function writeToSheet(sheetName, action, data) {
      try {
        const payload = { sheet: sheetName, action, ...data };
        
        const response = await fetch(CONFIG.script_url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        DATA._cache[sheetName].timestamp = 0;
        
        return result.success || false;
      } catch (error) {
        console.error(`‚úó Write ${sheetName}:`, error);
        return false;
      }
    }

    async function loadAllData() {
      try {
        const [users, exams, questions, answers, results] = await Promise.all([
          fetchFromSheet('users'),
          fetchFromSheet('exams'),
          fetchFromSheet('questions'),
          fetchFromSheet('answers'),
          fetchFromSheet('results')
        ]);

        DATA.users = users;
        DATA.exams = exams;
        DATA.questions = questions;
        DATA.answers = answers;
        DATA.results = results;

        backupToLocal();
        return true;
      } catch (error) {
        console.error('Load data error:', error);
        restoreFromLocal();
        return false;
      }
    }

    // ==================== BACKUP & RECOVERY ====================
    function backupToLocal() {
      try {
        const backup = {
          timestamp: new Date().toISOString(),
          data: {
            users: DATA.users,
            exams: DATA.exams,
            questions: DATA.questions,
            answers: DATA.answers,
            results: DATA.results
          }
        };
        localStorage.setItem('cbt_backup', JSON.stringify(backup));
      } catch (error) {
        console.error('Backup failed:', error);
      }
    }

    function restoreFromLocal() {
      try {
        const backup = localStorage.getItem('cbt_backup');
        if (backup) {
          const { data } = JSON.parse(backup);
          DATA.users = data.users || DATA.users;
          DATA.exams = data.exams || DATA.exams;
          DATA.questions = data.questions || DATA.questions;
          DATA.answers = data.answers || DATA.answers;
          DATA.results = data.results || DATA.results;
          showToast('Menggunakan data cadangan lokal', 'warning');
        }
      } catch (error) {
        console.error('Restore failed:', error);
      }
    }

    // ==================== AUTHENTIKASI ====================
    function checkAuth() {
      const token = localStorage.getItem('cbt_token');
      const user = localStorage.getItem('cbt_user');
      if (token && user) {
        currentUser = JSON.parse(user);
        currentView = 'dashboard';
        renderApp();
        startPolling();
        return true;
      }
      return false;
    }

    async function handleLogin() {
      const username = document.getElementById('username')?.value.trim();
      const password = document.getElementById('password')?.value.trim();

      if (!username || !password) {
        showToast('Masukkan username dan password!', 'error');
        return;
      }

      if (!validateInput(username, 'username') || !validateInput(password, 'password')) {
        showToast('Format username/password tidak valid!', 'error');
        return;
      }

      showLoading('Memverifikasi login...');

      await loadAllData();
      
      const user = DATA.users.find(u => {
        const dbUser = String(u.Username || '').trim().toLowerCase();
        const dbPass = String(u.Password || '').trim();
        return dbUser === username.toLowerCase() && dbPass === password;
      });
      
      if (user) {
        currentUser = {
          id: user.ID,
          username: user.Username,
          role: user.Role,
          name: user.Nama,
          kelas: user['Kelas/Mapel'],
          nis: user['NIS/NIP']
        };
        
        localStorage.setItem('cbt_token', generateUUID('token_'));
        localStorage.setItem('cbt_user', JSON.stringify(currentUser));
        
        currentView = 'dashboard';
        showToast(`Selamat datang, ${user.Nama}!`);
        hideLoading();
        renderApp();
        startPolling();
      } else {
        hideLoading();
        showToast('Username atau password salah!', 'error');
      }
    }

    function handleLogout() {
      localStorage.removeItem('cbt_token');
      localStorage.removeItem('cbt_user');
      clearAllIntervals();
      currentUser = null;
      currentView = 'login';
      currentExam = null;
      currentQuestion = null;
      examAnswers = {};
      deleteConfirmQueue = {};
      submittedBatches.clear();
      showToast('Berhasil logout');
      renderApp();
    }

    // ==================== UI COMPONENTS ====================
    function showLoading(message = 'Memuat...') {
      const existing = document.getElementById('loading-overlay');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.id = 'loading-overlay';
      overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full border-4 border-t-transparent border-blue-500 animate-spin"></div>
          <p class="text-slate-700 font-medium">${message}</p>
          <p class="text-slate-400 text-sm mt-2">Mohon tunggu sebentar</p>
        </div>
      `;
      document.body.appendChild(overlay);
    }

    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.remove();
    }

    function showSkeleton(type, count = 5) {
      if (type === 'table') {
        return Array(count).fill().map(() => `
          <tr><td colspan="6"><div class="h-12 skeleton rounded my-1"></div></td></tr>
        `).join('');
      } else if (type === 'card') {
        return Array(count).fill().map(() => `
          <div class="bg-white rounded-xl p-6 shadow-sm">
            <div class="h-4 skeleton rounded w-1/4 mb-4"></div>
            <div class="h-6 skeleton rounded w-3/4 mb-2"></div>
            <div class="h-4 skeleton rounded w-1/2"></div>
          </div>
        `).join('');
      }
      return '';
    }

    // ==================== POLLING SYSTEM ====================
    function startPolling() {
      if (pollingInterval) clearInterval(pollingInterval);
      
      pollingInterval = setInterval(async () => {
        if (currentUser && currentView === 'dashboard') {
          await loadAllData();
          updatePollingIndicator();
        }
      }, 30000); // 30 detik
    }

    function updatePollingIndicator() {
      const indicator = document.getElementById('polling-indicator');
      if (indicator) {
        indicator.classList.add('polling-indicator');
        setTimeout(() => indicator.classList.remove('polling-indicator'), 1000);
      }
    }

    function clearAllIntervals() {
      if (pollingInterval) clearInterval(pollingInterval);
      if (examTimer) clearInterval(examTimer);
    }

    // ==================== RENDER UTAMA ====================
    function renderApp() {
      const app = document.getElementById('app');
      
      if (currentView === 'login') {
        renderLoginPage(app);
      } else {
        renderDashboard(app);
      }
    }

    // ==================== HALAMAN LOGIN ====================
    function renderLoginPage(container) {
      container.innerHTML = `
        <div class="min-h-full w-full flex items-center justify-center p-4" 
          style="background: linear-gradient(135deg, ${CONFIG.primary_color} 0%, ${CONFIG.secondary_color} 100%);">
          
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 fade-in">
            <div class="text-center mb-8">
              <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center text-4xl text-white" 
                style="background: linear-gradient(135deg, ${CONFIG.primary_color}, ${CONFIG.secondary_color});">
                üìù
              </div>
              <h1 class="text-2xl font-bold" style="color: ${CONFIG.text_color};">Sistem CBT Sekolah</h1>
              <p class="text-slate-500 mt-1">${CONFIG.school_name}</p>
              <p class="text-slate-400 text-sm">Tahun Ajaran ${CONFIG.school_year}</p>
            </div>
            
            <div id="login-form">
              <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-2">Username</label>
                <input type="text" id="username" placeholder="Masukkan username" 
                  class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
              </div>
              
              <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-2">Password</label>
                <input type="password" id="password" placeholder="Masukkan password" 
                  class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                  onkeypress="if(event.key === 'Enter') handleLogin()">
              </div>
              
              <button onclick="handleLogin()" 
                class="w-full py-3 text-white font-semibold rounded-xl btn-primary shadow-lg hover:opacity-90" 
                style="background: linear-gradient(135deg, ${CONFIG.primary_color}, ${CONFIG.secondary_color});">
                Masuk ke Sistem
              </button>
              
              <div class="mt-6 p-4 bg-slate-50 rounded-xl">
                <p class="text-xs text-slate-500 text-center mb-2">Demo Login (klik untuk coba):</p>
                <div class="grid grid-cols-3 gap-2 text-xs">
                  <button onclick="quickLogin('siswa1', '123')" 
                    class="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition">Siswa</button>
                  <button onclick="quickLogin('guru1', '123')" 
                    class="px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition">Guru</button>
                  <button onclick="quickLogin('admin', 'admin')" 
                    class="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition">Admin</button>
                </div>
              </div>
            </div>
            
            <p class="text-center text-xs text-slate-400 mt-8">¬© ${new Date().getFullYear()} Sistem CBT Sekolah</p>
          </div>
        </div>
      `;
    }

    function quickLogin(username, password) {
      document.getElementById('username').value = username;
      document.getElementById('password').value = password;
      handleLogin();
    }

    // ==================== DASHBOARD LAYOUT ====================
    function renderDashboard(container) {
      const menuItems = getMenuItems();
      const isExamMode = currentSubView === 'take-exam';
      
      container.innerHTML = `
        <div class="h-full w-full flex">
          <!-- Sidebar -->
          <aside class="w-64 text-white flex-shrink-0 flex flex-col transition-all duration-300 ${isExamMode ? 'hidden' : ''}" 
            style="background: linear-gradient(180deg, ${CONFIG.primary_color} 0%, ${CONFIG.secondary_color} 100%);">
            
            <div class="p-6 border-b border-white/10">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center text-xl">üìù</div>
                <div>
                  <h1 class="font-bold text-lg">Sistem CBT</h1>
                  <p class="text-xs text-white/70 truncate">${CONFIG.school_name}</p>
                </div>
              </div>
            </div>
            
            <nav class="flex-1 p-4 overflow-y-auto">
              ${menuItems.map(item => `
                <button onclick="navigateTo('${item.view}')" 
                  class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-1 text-left transition ${currentSubView === item.view ? 'active' : ''}">
                  <span class="text-lg">${item.icon}</span>
                  <span class="text-sm font-medium">${item.label}</span>
                </button>
              `).join('')}
            </nav>
            
            <div class="p-4 border-t border-white/10">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-lg">
                  ${currentUser.role === 'siswa' ? 'üéì' : currentUser.role === 'guru' ? 'üë®‚Äçüè´' : '‚öôÔ∏è'}
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-medium text-sm truncate">${currentUser.name}</p>
                  <p class="text-xs text-white/70 capitalize">${currentUser.role}</p>
                </div>
              </div>
              
              <button onclick="toggleDarkMode()" class="w-full mb-2 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition flex items-center justify-center gap-2">
                <span>üåô</span> Mode Gelap
              </button>
              
              <button onclick="handleLogout()" 
                class="w-full py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition flex items-center justify-center gap-2">
                <span>üö™</span> Keluar
              </button>
              
              <div class="mt-3 text-xs text-white/60 flex items-center justify-center gap-1">
                <span id="polling-indicator">üîÑ</span> Auto-sync aktif
              </div>
            </div>
          </aside>
          
          <!-- Main Content -->
          <main class="flex-1 overflow-auto bg-slate-50 dark:bg-gray-800">
            <div id="main-content" class="p-6 h-full overflow-auto">
              ${renderMainContent()}
            </div>
          </main>
        </div>
      `;
    }

    function getMenuItems() {
      const baseItems = {
        siswa: [
          { view: 'dashboard', icon: 'üè†', label: 'Dashboard' },
          { view: 'exams', icon: 'üìã', label: 'Ujian Tersedia' },
          { view: 'results', icon: 'üìä', label: 'Hasil Ujian' }
        ],
        guru: [
          { view: 'dashboard', icon: 'üè†', label: 'Dashboard' },
          { view: 'exams', icon: 'üìã', label: 'Kelola Ujian' },
          { view: 'questions', icon: '‚ùì', label: 'Kelola Soal' },
          { view: 'results', icon: 'üìä', label: 'Hasil & Nilai' }
        ],
        admin: [
          { view: 'dashboard', icon: 'üè†', label: 'Dashboard' },
          { view: 'users', icon: 'üë•', label: 'Kelola User' },
          { view: 'exams', icon: 'üìã', label: 'Kelola Ujian' },
          { view: 'questions', icon: '‚ùì', label: 'Kelola Soal' },
          { view: 'results', icon: 'üìä', label: 'Hasil & Nilai' }
        ]
      };
      return baseItems[currentUser.role] || [];
    }

    function navigateTo(view) {
      currentSubView = view;
      currentQuestion = null;
      renderApp();
    }

    function renderMainContent() {
      switch(currentSubView) {
        case 'dashboard': return renderDashboardContent();
        case 'exams': return renderExamsContent();
        case 'questions': return renderQuestionsContent();
        case 'results': return renderResultsContent();
        case 'users': return renderUsersContent();
        case 'take-exam': return renderTakeExam();
        case 'edit-question': return renderEditQuestionPage();
        case 'add-exam': return renderAddExamPage();
        case 'add-user': return renderAddUserPage();
        default: return renderDashboardContent();
      }
    }

    // ==================== DASHBOARD CONTENT ====================
    function renderDashboardContent() {
      const stats = getDashboardStats();
      const actions = getQuickActions();
      
      return `
        <div class="fade-in">
          <div class="mb-6">
            <h2 class="text-2xl font-bold dark:text-white">Dashboard</h2>
            <p class="text-slate-500 dark:text-slate-300">Selamat datang kembali, ${currentUser.name}</p>
          </div>
          
          <!-- Stats Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            ${stats.map(stat => `
              <div class="bg-white dark:bg-gray-700 rounded-xl p-5 shadow-sm card-hover transition-all duration-300">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-500 dark:text-slate-300 text-sm">${stat.label}</p>
                    <p class="text-2xl font-bold mt-1" style="color: ${CONFIG.primary_color};">${stat.value}</p>
                    ${stat.subtext ? `<p class="text-xs text-slate-400 mt-1">${stat.subtext}</p>` : ''}
                  </div>
                  <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" 
                    style="background: ${stat.color}20; color: ${stat.color};">
                    ${stat.icon}
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <!-- Quick Actions -->
          <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm mb-6">
            <h3 class="font-semibold mb-4 dark:text-white">Aksi Cepat</h3>
            <div class="grid grid-cols-2 sm:grid-cols-${actions.length} gap-3">
              ${actions.map(action => `
                <button onclick="${action.action}" 
                  class="p-4 rounded-xl text-white font-medium flex items-center justify-center gap-3 btn-primary shadow-md hover:opacity-90"
                  style="background: ${action.color};">
                  <span class="text-xl">${action.icon}</span>
                  <span class="text-sm">${action.label}</span>
                </button>
              `).join('')}
            </div>
          </div>
          
          <!-- Recent Activity -->
          <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm">
            <h3 class="font-semibold mb-4 dark:text-white">Aktivitas Terbaru</h3>
            ${renderRecentActivity()}
          </div>
        </div>
      `;
    }

    function getDashboardStats() {
      if (currentUser.role === 'siswa') {
        const myExams = DATA.exams.filter(e => e.Kelas && e.Kelas.includes(currentUser.kelas));
        const myResults = DATA.results.filter(r => r.StudentID === currentUser.id);
        const avgScore = myResults.length ? 
          Math.round(myResults.reduce((a,b) => a + parseFloat(b.Nilai || 0), 0) / myResults.length) : 0;
        
        return [
          { label: 'Ujian Mendatang', value: myExams.filter(e => e.Status === 'scheduled').length, 
            icon: 'üìÖ', color: '#3b82f6', subtext: 'Belum dikerjakan' },
          { label: 'Ujian Selesai', value: myResults.length, 
            icon: '‚úÖ', color: '#10b981', subtext: 'Sudah dikumpulkan' },
          { label: 'Rata-rata Nilai', value: avgScore || '-', 
            icon: 'üìä', color: '#f59e0b', subtext: 'Dari semua ujian' },
          { label: 'Nilai Tertinggi', value: myResults.length ? Math.max(...myResults.map(r => parseFloat(r.Nilai || 0))) : '-', 
            icon: 'üèÜ', color: '#8b5cf6', subtext: 'Pencapaian terbaik' }
        ];
      } else if (currentUser.role === 'guru') {
        const myExams = DATA.exams.filter(e => e.CreatedBy === currentUser.id);
        const myQuestions = DATA.questions.filter(q => myExams.some(e => e.ID === q.ExamID));
        
        return [
          { label: 'Total Ujian', value: myExams.length, icon: 'üìã', color: '#3b82f6' },
          { label: 'Ujian Aktif', value: myExams.filter(e => e.Status === 'active').length, icon: '‚ñ∂Ô∏è', color: '#10b981' },
          { label: 'Total Soal', value: myQuestions.length, icon: '‚ùì', color: '#f59e0b' },
          { label: 'Sudah Dinilai', value: DATA.results.filter(r => r.Status === 'graded').length, icon: '‚úÖ', color: '#8b5cf6' }
        ];
      } else {
        return [
          { label: 'Total User', value: DATA.users.length, icon: 'üë•', color: '#3b82f6' },
          { label: 'Total Ujian', value: DATA.exams.length, icon: 'üìã', color: '#10b981' },
          { label: 'Total Soal', value: DATA.questions.length, icon: '‚ùì', color: '#f59e0b' },
          { label: 'Hasil Ujian', value: DATA.results.length, icon: 'üìä', color: '#8b5cf6' }
        ];
      }
    }

    function getQuickActions() {
      if (currentUser.role === 'siswa') {
        return [
          { label: 'Mulai Ujian', icon: '‚ñ∂Ô∏è', action: "navigateTo('exams')", color: CONFIG.accent_color },
          { label: 'Lihat Nilai', icon: 'üìä', action: "navigateTo('results')", color: CONFIG.secondary_color }
        ];
      } else if (currentUser.role === 'guru') {
        return [
          { label: 'Buat Ujian', icon: 'üìã', action: "navigateTo('add-exam')", color: CONFIG.accent_color },
          { label: 'Tambah Soal', icon: '‚ùì', action: "navigateTo('questions')", color: CONFIG.secondary_color },
          { label: 'Lihat Nilai', icon: 'üìä', action: "navigateTo('results')", color: '#f59e0b' }
        ];
      } else {
        return [
          { label: 'Kelola User', icon: 'üë•', action: "navigateTo('users')", color: CONFIG.accent_color },
          { label: 'Kelola Ujian', icon: 'üìã', action: "navigateTo('exams')", color: CONFIG.secondary_color },
          { label: 'Kelola Soal', icon: '‚ùì', action: "navigateTo('questions')", color: '#f59e0b' },
          { label: 'Export Data', icon: 'üì§', action: "exportAllData()", color: '#8b5cf6' }
        ];
      }
    }

    function renderRecentActivity() {
      if (currentUser.role === 'siswa') {
        const myResults = DATA.results.filter(r => r.StudentID === currentUser.id).slice(0, 5);
        if (!myResults.length) return '<p class="text-slate-400 dark:text-slate-300">Belum ada aktivitas</p>';
        
        return myResults.map(result => {
          const exam = DATA.exams.find(e => e.ID === result.ExamID);
          return `
            <div class="flex items-center justify-between py-3 border-b dark:border-gray-600">
              <div>
                <p class="font-medium dark:text-white">${exam?.Judul || 'Ujian'}</p>
                <p class="text-sm text-slate-500 dark:text-slate-300">${result.TanggalSubmit || 'Belum dikumpulkan'}</p>
              </div>
              <span class="px-3 py-1 rounded-full font-bold text-white text-sm"
                style="background: ${parseFloat(result.Nilai) >= 80 ? CONFIG.accent_color : parseFloat(result.Nilai) >= 60 ? '#f59e0b' : '#ef4444'};">
                ${result.Nilai || '0'}
              </span>
            </div>
          `;
        }).join('');
      }
      return '<p class="text-slate-400 dark:text-slate-300">Tidak ada aktivitas terbaru</p>';
    }

    // ==================== KELOLA UJIAN ====================
    function renderExamsContent() {
      if (currentUser.role === 'siswa') {
        return renderStudentExams();
      } else {
        return renderTeacherExams();
      }
    }

    function renderStudentExams() {
      const availableExams = DATA.exams.filter(e => 
        e.Kelas && e.Kelas.includes(currentUser.kelas) && 
        (e.Status === 'scheduled' || e.Status === 'active')
      );
      
      const myResults = DATA.results.filter(r => r.StudentID === currentUser.id);
      const completedExamIds = myResults.map(r => r.ExamID);
      
      return `
        <div class="fade-in">
          <div class="mb-6">
            <h2 class="text-2xl font-bold dark:text-white">Ujian Tersedia</h2>
            <p class="text-slate-500 dark:text-slate-300">Kelas ${currentUser.kelas}</p>
          </div>
          
          ${availableExams.length ? `
            <div class="grid gap-4">
              ${availableExams.map(exam => {
                const isCompleted = completedExamIds.includes(exam.ID);
                const myResult = myResults.find(r => r.ExamID === exam.ID);
                
                return `
                  <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm card-hover transition-all duration-300">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          ${getStatusBadge(exam.Status)}
                          ${isCompleted ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">‚úì Selesai</span>' : ''}
                        </div>
                        <h3 class="font-semibold text-lg dark:text-white">${exam.Judul}</h3>
                        <p class="text-slate-500 dark:text-slate-300 text-sm mt-1">${exam.Mapel}</p>
                        
                        <div class="flex flex-wrap gap-4 mt-4 text-sm text-slate-600 dark:text-slate-300">
                          <span class="flex items-center gap-1">üìÖ ${formatDate(exam.Tanggal)}</span>
                          <span class="flex items-center gap-1">üïí ${exam.Waktu}</span>
                          <span class="flex items-center gap-1">‚è±Ô∏è ${exam.Durasi} menit</span>
                          <span class="flex items-center gap-1">üìù ${exam.TotalSoal || '?'} soal</span>
                        </div>
                        
                        ${myResult ? `
                          <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <p class="text-sm text-blue-700 dark:text-blue-300">
                              <strong>Nilai: ${myResult.Nilai}</strong> ‚Ä¢ 
                              Benar: ${myResult.BenarCount}/${myResult.TotalSoal}
                            </p>
                          </div>
                        ` : ''}
                      </div>
                      
                      ${!isCompleted ? `
                        <button onclick="startExam('${exam.ID}')"
                          class="px-6 py-3 text-white font-medium rounded-xl btn-primary shadow-md hover:opacity-90"
                          style="background: ${CONFIG.accent_color};">
                          Mulai Ujian
                        </button>
                      ` : `
                        <button onclick="viewExamResult('${exam.ID}')"
                          class="px-6 py-3 bg-purple-100 text-purple-700 font-medium rounded-xl hover:bg-purple-200">
                          Lihat Hasil
                        </button>
                      `}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="bg-white dark:bg-gray-700 rounded-xl p-12 text-center shadow-sm">
              <div class="text-6xl mb-4">üìã</div>
              <h3 class="text-xl font-semibold dark:text-white">Tidak Ada Ujian</h3>
              <p class="text-slate-500 dark:text-slate-300 mt-2">Belum ada ujian yang tersedia untuk kelas Anda.</p>
            </div>
          `}
        </div>
      `;
    }

    function renderTeacherExams() {
      const myExams = currentUser.role === 'admin' ? DATA.exams : DATA.exams.filter(e => e.CreatedBy === currentUser.id);
      
      return `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Kelola Ujian</h2>
              <p class="text-slate-500 dark:text-slate-300">${myExams.length} ujian ditemukan</p>
            </div>
            <div class="flex gap-2">
              <button onclick="exportExamData()"
                class="px-4 py-2 bg-green-100 text-green-700 font-medium rounded-xl hover:bg-green-200">
                üì§ Export
              </button>
              <button onclick="navigateTo('add-exam')"
                class="px-4 py-2 text-white font-medium rounded-xl btn-primary shadow-md"
                style="background: ${CONFIG.accent_color};">
                + Tambah Ujian
              </button>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-slate-50 dark:bg-gray-600 border-b">
                <tr>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Judul Ujian</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Mapel</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Kelas</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Jadwal</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Status</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${myExams.length ? myExams.map(exam => {
                  const questionCount = DATA.questions.filter(q => q.ExamID === exam.ID).length;
                  const answerCount = DATA.answers.filter(a => a.ExamID === exam.ID).length;
                  
                  return `
                    <tr class="border-b dark:border-gray-600 hover:bg-slate-50 dark:hover:bg-gray-600">
                      <td class="py-4 px-6">
                        <p class="font-medium dark:text-white">${exam.Judul}</p>
                        <p class="text-xs text-slate-400">${questionCount} soal ‚Ä¢ ${exam.Durasi} menit</p>
                      </td>
                      <td class="py-4 px-6 text-slate-600 dark:text-slate-300">${exam.Mapel}</td>
                      <td class="py-4 px-6 text-slate-600 dark:text-slate-300 text-sm">${exam.Kelas}</td>
                      <td class="py-4 px-6 text-slate-600 dark:text-slate-300 text-sm">
                        ${formatDate(exam.Tanggal)}<br>${exam.Waktu}
                      </td>
                      <td class="py-4 px-6">
                        ${getStatusBadge(exam.Status)}<br>
                        <span class="text-xs text-slate-400">${answerCount} jawaban</span>
                      </td>
                      <td class="py-4 px-6">
                        <div class="flex gap-2">
                          <button onclick="editExam('${exam.ID}')"
                            class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            Edit
                          </button>
                          <button onclick="deleteExam('${exam.ID}')"
                            class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                            Hapus
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('') : `
                  <tr>
                    <td colspan="6" class="py-12 text-center text-slate-400">
                      Belum ada ujian yang dibuat
                    </td>
                  </tr>
                `}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderAddExamPage() {
      return `
        <div class="fade-in max-w-2xl">
          <div class="flex items-center gap-4 mb-6">
            <button onclick="navigateTo('exams')" class="text-2xl dark:text-white">‚Üê</button>
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Tambah Ujian Baru</h2>
              <p class="text-slate-500 dark:text-slate-300">Isi data ujian dengan lengkap</p>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Judul Ujian *</label>
              <input type="text" id="exam-title" placeholder="Contoh: Ujian Tengah Semester Matematika"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Mata Pelajaran *</label>
                <input type="text" id="exam-subject" placeholder="Matematika, IPA, Bahasa Indonesia"
                  class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Kelas *</label>
                <select id="exam-class" class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="X IPA 1">X IPA 1</option>
                  <option value="X IPA 2">X IPA 2</option>
                  <option value="XI IPA 1">XI IPA 1</option>
                  <option value="XI IPA 2">XI IPA 2</option>
                  <option value="XII IPA 1">XII IPA 1</option>
                  <option value="XII IPA 2">XII IPA 2</option>
                  <option value="X IPS 1">X IPS 1</option>
                  <option value="X IPS 2">X IPS 2</option>
                  <option value="XI IPS 1">XI IPS 1</option>
                  <option value="XI IPS 2">XI IPS 2</option>
                  <option value="XII IPS 1">XII IPS 1</option>
                  <option value="XII IPS 2">XII IPS 2</option>
                </select>
              </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Tanggal *</label>
                <input type="date" id="exam-date"
                  class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Waktu *</label>
                <input type="time" id="exam-time"
                  class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Durasi (menit) *</label>
                <input type="number" id="exam-duration" min="5" max="180" value="120"
                  class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Status *</label>
                <select id="exam-status" class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="scheduled">Terjadwal</option>
                  <option value="active">Aktif</option>
                  <option value="completed">Selesai</option>
                </select>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Instruksi (Opsional)</label>
              <textarea id="exam-instruction" rows="3" placeholder="Instruksi untuk siswa..."
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="navigateTo('exams')"
              class="px-6 py-3 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-xl hover:bg-slate-200 dark:hover:bg-gray-500 transition font-medium">
              Batal
            </button>
            <button onclick="saveNewExam()"
              class="px-6 py-3 text-white rounded-xl btn-primary shadow-md font-medium flex-1"
              style="background: ${CONFIG.accent_color};">
              üíæ Simpan Ujian
            </button>
          </div>
        </div>
      `;
    }

    async function saveNewExam() {
      const title = document.getElementById('exam-title')?.value.trim();
      const subject = document.getElementById('exam-subject')?.value.trim();
      const kelas = document.getElementById('exam-class')?.value;
      const date = document.getElementById('exam-date')?.value;
      const time = document.getElementById('exam-time')?.value;
      const duration = parseInt(document.getElementById('exam-duration')?.value || 120);
      const status = document.getElementById('exam-status')?.value;
      const instruction = document.getElementById('exam-instruction')?.value.trim();

      if (!title || !subject || !kelas || !date || !time) {
        showToast('Harap isi semua field yang wajib!', 'error');
        return;
      }

      showLoading('Menyimpan ujian...');

      const examId = generateUUID('EXAM_');
      const success = await writeToSheet('exams', 'append', {
        row: [
          examId,
          title,
          subject,
          kelas,
          date,
          time,
          duration,
          '0', // TotalSoal akan diupdate nanti
          status || 'scheduled',
          instruction || '',
          currentUser.id,
          new Date().toISOString()
        ]
      });

      hideLoading();

      if (success) {
        showToast('Ujian berhasil dibuat!');
        await loadAllData();
        navigateTo('exams');
      } else {
        showToast('Gagal menyimpan ujian', 'error');
      }
    }

    function editExam(examId) {
      showToast('Fitur edit ujian akan segera tersedia', 'info');
    }

    async function deleteExam(examId) {
      if (!confirm('Hapus ujian ini? Soal dan hasil ujian juga akan dihapus.')) return;
      
      showLoading('Menghapus ujian...');
      const success = await writeToSheet('exams', 'delete', { id: examId });
      
      if (success) {
        showToast('Ujian berhasil dihapus');
        await loadAllData();
        renderApp();
      } else {
        showToast('Gagal menghapus ujian', 'error');
      }
      hideLoading();
    }

    // ==================== KELOLA SOAL ====================
    function renderQuestionsContent() {
      const myExams = currentUser.role === 'admin' ? DATA.exams : DATA.exams.filter(e => e.CreatedBy === currentUser.id);
      const selectedExamId = DATA._selectedExamId || (myExams[0]?.ID || '');
      const myQuestions = DATA.questions.filter(q => !selectedExamId || q.ExamID === selectedExamId);
      const selectedExam = DATA.exams.find(e => e.ID === selectedExamId);
      const totalPoints = myQuestions.reduce((sum, q) => sum + parseInt(q.Poin || 0), 0);

      return `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Kelola Soal</h2>
              <p class="text-slate-500 dark:text-slate-300">${myQuestions.length} soal ditemukan</p>
            </div>
            <button onclick="openAddQuestionModal()"
              class="px-4 py-2 text-white font-medium rounded-xl btn-primary shadow-md"
              style="background: ${CONFIG.accent_color};">
              + Tambah Soal
            </button>
          </div>
          
          <!-- Filter by Exam -->
          <div class="mb-6 bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm">
            <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Pilih Ujian:</label>
            <select onchange="filterQuestionsByExam(this.value)" 
              class="w-full md:w-96 px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">Semua Ujian</option>
              ${myExams.map(exam => `
                <option value="${exam.ID}" ${exam.ID === selectedExamId ? 'selected' : ''}>
                  ${exam.Judul} (${exam.Mapel})
                </option>
              `).join('')}
            </select>
          </div>
          
          ${selectedExamId && selectedExam ? `
            <!-- Exam Info -->
            <div class="bg-white dark:bg-gray-700 rounded-xl p-4 mb-6 shadow-sm">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-semibold dark:text-white">${selectedExam.Judul}</h3>
                  <p class="text-sm text-slate-500 dark:text-slate-300">${selectedExam.Mapel} ‚Ä¢ ${selectedExam.Kelas}</p>
                </div>
                <button onclick="exportQuestions('${selectedExamId}')"
                  class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
                  üì• Export Soal
                </button>
              </div>
            </div>
            
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm">
                <p class="text-slate-500 dark:text-slate-300 text-sm">Total Soal</p>
                <p class="text-2xl font-bold" style="color: ${CONFIG.primary_color};">${myQuestions.length}</p>
              </div>
              <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm">
                <p class="text-slate-500 dark:text-slate-300 text-sm">Total Poin</p>
                <p class="text-2xl font-bold" style="color: ${CONFIG.primary_color};">${totalPoints}</p>
              </div>
              <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm">
                <p class="text-slate-500 dark:text-slate-300 text-sm">Pilihan Ganda</p>
                <p class="text-2xl font-bold" style="color: ${CONFIG.secondary_color};">${myQuestions.filter(q => q.Tipe === 'pilihan_ganda').length}</p>
              </div>
              <div class="bg-white dark:bg-gray-700 rounded-xl p-4 shadow-sm">
                <p class="text-slate-500 dark:text-slate-300 text-sm">Essay</p>
                <p class="text-2xl font-bold" style="color: #f59e0b;">${myQuestions.filter(q => q.Tipe === 'essay').length}</p>
              </div>
            </div>
            
            <!-- Questions List -->
            <div class="space-y-4">
              ${myQuestions.length ? myQuestions.map((q, index) => `
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm ${deleteConfirmQueue[q.ID] ? 'delete-pending' : ''}">
                  <div class="flex items-start gap-4">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-white flex-shrink-0" 
                      style="background: ${CONFIG.primary_color};">
                      ${index + 1}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-2 mb-2 flex-wrap">
                        <span class="px-2 py-1 text-xs rounded-full font-medium ${q.Tipe === 'pilihan_ganda' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">
                          ${q.Tipe === 'pilihan_ganda' ? 'Pilihan Ganda' : 'Essay'}
                        </span>
                        <span class="text-xs bg-slate-100 dark:bg-gray-600 text-slate-700 dark:text-slate-300 px-2 py-1 rounded-full">
                          ${q.Poin || 0} poin
                        </span>
                        ${q.Tipe === 'pilihan_ganda' ? `
                          <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                            Jawaban: ${String.fromCharCode(65 + parseInt(q.JawabanBenar || 0))}
                          </span>
                        ` : ''}
                      </div>
                      <p class="font-medium text-sm md:text-base dark:text-white mb-3">${q.Pertanyaan}</p>
                      
                      ${q.Tipe === 'pilihan_ganda' ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                          ${[q.OpsiA, q.OpsiB, q.OpsiC, q.OpsiD].map((opt, i) => `
                            <div class="p-2 rounded-lg text-xs md:text-sm ${i == q.JawabanBenar ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 font-medium' : 'bg-slate-50 dark:bg-gray-800 text-slate-600 dark:text-slate-300'}">
                              <span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span>
                              ${opt || '-'}
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2 flex-shrink-0">
                      <button onclick="editQuestion('${q.ID}')"
                        class="px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition text-sm font-medium">
                        ‚úèÔ∏è Edit
                      </button>
                      ${!deleteConfirmQueue[q.ID] ? `
                        <button onclick="confirmDelete('${q.ID}')"
                          class="px-3 py-2 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition text-sm font-medium">
                          üóëÔ∏è Hapus
                        </button>
                      ` : `
                        <div class="flex gap-1">
                          <button onclick="deleteQuestion('${q.ID}')"
                            class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-medium">
                            Yakin?
                          </button>
                          <button onclick="cancelDelete('${q.ID}')"
                            class="px-3 py-2 bg-slate-300 dark:bg-gray-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-400 dark:hover:bg-gray-500 transition text-sm font-medium">
                            Batal
                          </button>
                        </div>
                      `}
                    </div>
                  </div>
                </div>
              `).join('') : `
                <div class="bg-white dark:bg-gray-700 rounded-xl p-12 text-center shadow-sm">
                  <div class="text-6xl mb-4">‚ùì</div>
                  <h3 class="text-xl font-semibold dark:text-white">Belum Ada Soal</h3>
                  <p class="text-slate-500 dark:text-slate-300 mt-2">Tambahkan soal untuk ujian ini.</p>
                </div>
              `}
            </div>
          ` : `
            <div class="bg-white dark:bg-gray-700 rounded-xl p-12 text-center shadow-sm">
              <div class="text-6xl mb-4">üìã</div>
              <h3 class="text-xl font-semibold dark:text-white">Pilih Ujian</h3>
              <p class="text-slate-500 dark:text-slate-300 mt-2">Pilih ujian dari dropdown di atas untuk mengelola soal.</p>
            </div>
          `}
        </div>
      `;
    }

    function filterQuestionsByExam(examId) {
      DATA._selectedExamId = examId;
      renderApp();
    }

    function openAddQuestionModal() {
      const myExams = currentUser.role === 'admin' ? DATA.exams : DATA.exams.filter(e => e.CreatedBy === currentUser.id);
      
      if (!myExams.length) {
        showToast('Buat ujian terlebih dahulu', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto';
      modal.innerHTML = `
        <div class="modal-content bg-white dark:bg-gray-700 rounded-2xl shadow-2xl w-full max-w-2xl my-8">
          <div class="p-6 border-b dark:border-gray-600 flex items-center justify-between">
            <h3 class="text-xl font-bold dark:text-white">Tambah Soal Baru</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 text-2xl">√ó</button>
          </div>
          
          <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Ujian *</label>
              <select id="modal-exam-id" class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                ${myExams.map(e => `<option value="${e.ID}">${e.Judul} (${e.Mapel})</option>`).join('')}
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Tipe Soal *</label>
              <select id="modal-tipe" onchange="toggleQuestionOptions(this.value)"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="pilihan_ganda">Pilihan Ganda</option>
                <option value="essay">Essay</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Pertanyaan *</label>
              <textarea id="modal-pertanyaan" placeholder="Masukkan pertanyaan..."
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
            </div>
            
            <div id="modal-options-container">
              <!-- Options akan diisi oleh toggleQuestionOptions -->
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Poin *</label>
              <input type="number" id="modal-poin" value="5" min="1" max="100"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
          
          <div class="p-6 border-t dark:border-gray-600 flex gap-3 justify-end">
            <button onclick="closeModal()"
              class="px-4 py-2 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-500 transition font-medium">
              Batal
            </button>
            <button onclick="saveNewQuestion()"
              class="px-4 py-2 text-white rounded-lg btn-primary shadow-md font-medium"
              style="background: ${CONFIG.accent_color};">
              Simpan Soal
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      toggleQuestionOptions('pilihan_ganda');
    }

    function toggleQuestionOptions(type) {
      const container = document.getElementById('modal-options-container');
      if (!container) return;
      
      if (type === 'essay') {
        container.innerHTML = `
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Petunjuk Jawaban (Opsional)</label>
            <textarea id="modal-essay-guide" placeholder="Petunjuk untuk penilai..."
              class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi A *</label>
              <input type="text" id="modal-opsi-a" placeholder="Masukkan opsi A"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi B *</label>
              <input type="text" id="modal-opsi-b" placeholder="Masukkan opsi B"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi C *</label>
              <input type="text" id="modal-opsi-c" placeholder="Masukkan opsi C"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi D *</label>
              <input type="text" id="modal-opsi-d" placeholder="Masukkan opsi D"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Jawaban Benar *</label>
              <select id="modal-jawaban-benar" 
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="0">A</option>
                <option value="1">B</option>
                <option value="2">C</option>
                <option value="3">D</option>
              </select>
            </div>
          </div>
        `;
      }
    }

    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    }

    async function saveNewQuestion() {
      const examId = document.getElementById('modal-exam-id').value;
      const tipe = document.getElementById('modal-tipe').value;
      const pertanyaan = document.getElementById('modal-pertanyaan').value.trim();
      const poin = parseInt(document.getElementById('modal-poin').value) || 5;

      if (!pertanyaan) {
        showToast('Pertanyaan tidak boleh kosong!', 'error');
        return;
      }

      if (poin < 1 || poin > 100) {
        showToast('Poin harus antara 1-100!', 'error');
        return;
      }

      let data = {
        ID: generateUUID('Q_'),
        ExamID: examId,
        Pertanyaan: pertanyaan,
        Tipe: tipe,
        Poin: poin,
        OpsiA: '', OpsiB: '', OpsiC: '', OpsiD: '',
        JawabanBenar: 0
      };

      if (tipe === 'pilihan_ganda') {
        const opsiA = document.getElementById('modal-opsi-a').value.trim();
        const opsiB = document.getElementById('modal-opsi-b').value.trim();
        const opsiC = document.getElementById('modal-opsi-c').value.trim();
        const opsiD = document.getElementById('modal-opsi-d').value.trim();

        if (!opsiA || !opsiB || !opsiC || !opsiD) {
          showToast('Semua opsi harus diisi untuk soal pilihan ganda!', 'error');
          return;
        }

        data.OpsiA = opsiA;
        data.OpsiB = opsiB;
        data.OpsiC = opsiC;
        data.OpsiD = opsiD;
        data.JawabanBenar = parseInt(document.getElementById('modal-jawaban-benar').value);
      }

      showLoading('Menyimpan soal...');

      const success = await writeToSheet('questions', 'append', {
        row: [
          data.ID,
          data.ExamID,
          data.Pertanyaan,
          data.Tipe,
          data.OpsiA,
          data.OpsiB,
          data.OpsiC,
          data.OpsiD,
          data.JawabanBenar,
          data.Poin
        ]
      });

      hideLoading();
      closeModal();

      if (success) {
        showToast('Soal berhasil ditambahkan!');
        await loadAllData();
        renderApp();
      } else {
        showToast('Gagal menambahkan soal', 'error');
      }
    }

    function editQuestion(questionId) {
      currentQuestion = DATA.questions.find(q => q.ID === questionId);
      if (!currentQuestion) {
        showToast('Soal tidak ditemukan', 'error');
        return;
      }
      currentSubView = 'edit-question';
      renderApp();
    }

    function renderEditQuestionPage() {
      if (!currentQuestion) {
        navigateTo('questions');
        return '';
      }

      const exam = DATA.exams.find(e => e.ID === currentQuestion.ExamID);

      return `
        <div class="fade-in max-w-2xl">
          <div class="flex items-center gap-4 mb-6">
            <button onclick="navigateTo('questions')" class="text-2xl dark:text-white">‚Üê</button>
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Edit Soal</h2>
              <p class="text-slate-500 dark:text-slate-300">${exam?.Judul || 'Ujian'}</p>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Ujian</label>
              <input type="text" value="${exam?.Judul || ''}" disabled
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-slate-300 rounded-lg">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Tipe Soal</label>
              <input type="text" value="${currentQuestion.Tipe === 'pilihan_ganda' ? 'Pilihan Ganda' : 'Essay'}" disabled
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-slate-300 rounded-lg">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Pertanyaan *</label>
              <textarea id="edit-pertanyaan"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3">${currentQuestion.Pertanyaan}</textarea>
            </div>
            
            ${currentQuestion.Tipe === 'pilihan_ganda' ? `
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi A *</label>
                  <input type="text" id="edit-opsi-a" value="${currentQuestion.OpsiA || ''}"
                    class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi B *</label>
                  <input type="text" id="edit-opsi-b" value="${currentQuestion.OpsiB || ''}"
                    class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi C *</label>
                  <input type="text" id="edit-opsi-c" value="${currentQuestion.OpsiC || ''}"
                    class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Opsi D *</label>
                  <input type="text" id="edit-opsi-d" value="${currentQuestion.OpsiD || ''}"
                    class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Jawaban Benar *</label>
                  <select id="edit-jawaban-benar"
                    class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="0" ${currentQuestion.JawabanBenar == 0 ? 'selected' : ''}>A</option>
                    <option value="1" ${currentQuestion.JawabanBenar == 1 ? 'selected' : ''}>B</option>
                    <option value="2" ${currentQuestion.JawabanBenar == 2 ? 'selected' : ''}>C</option>
                    <option value="3" ${currentQuestion.JawabanBenar == 3 ? 'selected' : ''}>D</option>
                  </select>
                </div>
              </div>
            ` : ''}
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Poin *</label>
              <input type="number" id="edit-poin" value="${currentQuestion.Poin || 5}" min="1" max="100"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="navigateTo('questions')"
              class="px-6 py-3 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-xl hover:bg-slate-200 dark:hover:bg-gray-500 transition font-medium">
              Batal
            </button>
            <button onclick="saveEditedQuestion()"
              class="px-6 py-3 text-white rounded-xl btn-primary shadow-md font-medium flex-1"
              style="background: ${CONFIG.accent_color};">
              üíæ Simpan Perubahan
            </button>
          </div>
        </div>
      `;
    }

    async function saveEditedQuestion() {
      const pertanyaan = document.getElementById('edit-pertanyaan').value.trim();
      const poin = parseInt(document.getElementById('edit-poin').value) || 5;

      if (!pertanyaan) {
        showToast('Pertanyaan tidak boleh kosong!', 'error');
        return;
      }

      if (poin < 1 || poin > 100) {
        showToast('Poin harus antara 1-100!', 'error');
        return;
      }

      let updatedData = {
        ID: currentQuestion.ID,
        ExamID: currentQuestion.ExamID,
        Pertanyaan: pertanyaan,
        Tipe: currentQuestion.Tipe,
        Poin: poin,
        OpsiA: currentQuestion.OpsiA,
        OpsiB: currentQuestion.OpsiB,
        OpsiC: currentQuestion.OpsiC,
        OpsiD: currentQuestion.OpsiD,
        JawabanBenar: currentQuestion.JawabanBenar
      };

      if (currentQuestion.Tipe === 'pilihan_ganda') {
        const opsiA = document.getElementById('edit-opsi-a').value.trim();
        const opsiB = document.getElementById('edit-opsi-b').value.trim();
        const opsiC = document.getElementById('edit-opsi-c').value.trim();
        const opsiD = document.getElementById('edit-opsi-d').value.trim();

        if (!opsiA || !opsiB || !opsiC || !opsiD) {
          showToast('Semua opsi harus diisi!', 'error');
          return;
        }

        updatedData.OpsiA = opsiA;
        updatedData.OpsiB = opsiB;
        updatedData.OpsiC = opsiC;
        updatedData.OpsiD = opsiD;
        updatedData.JawabanBenar = parseInt(document.getElementById('edit-jawaban-benar').value);
      }

      showLoading('Menyimpan perubahan...');

      const success = await writeToSheet('questions', 'update', {
        id: currentQuestion.ID,
        row: [
          updatedData.ID,
          updatedData.ExamID,
          updatedData.Pertanyaan,
          updatedData.Tipe,
          updatedData.OpsiA,
          updatedData.OpsiB,
          updatedData.OpsiC,
          updatedData.OpsiD,
          updatedData.JawabanBenar,
          updatedData.Poin
        ]
      });

      hideLoading();

      if (success) {
        showToast('Soal berhasil diperbarui!');
        currentQuestion = null;
        await loadAllData();
        navigateTo('questions');
      } else {
        showToast('Gagal memperbarui soal', 'error');
      }
    }

    function confirmDelete(questionId) {
      deleteConfirmQueue[questionId] = true;
      renderApp();
    }

    function cancelDelete(questionId) {
      delete deleteConfirmQueue[questionId];
      renderApp();
    }

    async function deleteQuestion(questionId) {
      showLoading('Menghapus soal...');
      const success = await writeToSheet('questions', 'delete', { id: questionId });
      
      if (success) {
        showToast('Soal berhasil dihapus!');
        delete deleteConfirmQueue[questionId];
        await loadAllData();
        renderApp();
      } else {
        showToast('Gagal menghapus soal', 'error');
      }
      hideLoading();
    }

    // ==================== KELOLA USER ====================
    function renderUsersContent() {
      return `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Kelola User</h2>
              <p class="text-slate-500 dark:text-slate-300">${DATA.users.length} user terdaftar</p>
            </div>
            <button onclick="navigateTo('add-user')"
              class="px-4 py-2 text-white font-medium rounded-xl btn-primary shadow-md"
              style="background: ${CONFIG.accent_color};">
              + Tambah User
            </button>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-slate-50 dark:bg-gray-600 border-b">
                <tr>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Nama</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Username</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Role</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Info</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Aksi</th>
                </tr>
              </thead>
              <tbody>
                ${DATA.users.map(user => `
                  <tr class="border-b dark:border-gray-600 hover:bg-slate-50 dark:hover:bg-gray-600 ${deleteConfirmQueue[user.ID] ? 'delete-pending' : ''}">
                    <td class="py-4 px-6">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg
                          ${user.Role === 'siswa' ? 'bg-blue-100 text-blue-700' : 
                            user.Role === 'guru' ? 'bg-green-100 text-green-700' : 
                            'bg-purple-100 text-purple-700'}">
                          ${user.Role === 'siswa' ? 'üéì' : user.Role === 'guru' ? 'üë®‚Äçüè´' : '‚öôÔ∏è'}
                        </div>
                        <span class="font-medium dark:text-white">${user.Nama}</span>
                      </div>
                    </td>
                    <td class="py-4 px-6 text-slate-600 dark:text-slate-300 text-sm">${user.Username}</td>
                    <td class="py-4 px-6">
                      <span class="px-3 py-1 rounded-full text-xs font-medium capitalize
                        ${user.Role === 'siswa' ? 'bg-blue-100 text-blue-700' : 
                          user.Role === 'guru' ? 'bg-green-100 text-green-700' : 
                          'bg-purple-100 text-purple-700'}">
                        ${user.Role}
                      </span>
                    </td>
                    <td class="py-4 px-6 text-slate-500 dark:text-slate-300 text-sm">
                      ${user.Role === 'siswa' ? `Kelas: ${user['Kelas/Mapel']}` : 
                       user.Role === 'guru' ? `${user['Kelas/Mapel']}` : 
                       'Administrator'}
                    </td>
                    <td class="py-4 px-6">
                      <div class="flex gap-2">
                        <button onclick="editUser('${user.ID}')"
                          class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                          Edit
                        </button>
                        ${!deleteConfirmQueue[user.ID] ? `
                          <button onclick="confirmDeleteUser('${user.ID}')"
                            class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                            Hapus
                          </button>
                        ` : `
                          <button onclick="deleteUser('${user.ID}')"
                            class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                            Yakin?
                          </button>
                          <button onclick="cancelDeleteUser('${user.ID}')"
                            class="px-2 py-1 text-xs bg-slate-300 text-slate-700 rounded hover:bg-slate-400">
                            Batal
                          </button>
                        `}
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function renderAddUserPage() {
      return `
        <div class="fade-in max-w-2xl">
          <div class="flex items-center gap-4 mb-6">
            <button onclick="navigateTo('users')" class="text-2xl dark:text-white">‚Üê</button>
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Tambah User Baru</h2>
              <p class="text-slate-500 dark:text-slate-300">Tambahkan user siswa, guru, atau admin</p>
            </div>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Nama Lengkap *</label>
              <input type="text" id="user-name" placeholder="Nama lengkap"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Username *</label>
                <input type="text" id="user-username" placeholder="Username unik"
                  class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Password *</label>
                <input type="password" id="user-password" placeholder="Minimal 6 karakter"
                  class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Role *</label>
              <select id="user-role" onchange="toggleUserFields(this.value)"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="siswa">Siswa</option>
                <option value="guru">Guru</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            
            <div id="user-fields-container">
              <!-- Fields akan diisi oleh toggleUserFields -->
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">NIS/NIP *</label>
              <input type="text" id="user-nisnip" placeholder="Nomor induk"
                class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
          
          <div class="flex gap-3 mt-6">
            <button onclick="navigateTo('users')"
              class="px-6 py-3 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-xl hover:bg-slate-200 dark:hover:bg-gray-500 transition font-medium">
              Batal
            </button>
            <button onclick="saveNewUser()"
              class="px-6 py-3 text-white rounded-xl btn-primary shadow-md font-medium flex-1"
              style="background: ${CONFIG.accent_color};">
              üë§ Simpan User
            </button>
          </div>
        </div>
      `;
    }

    function toggleUserFields(role) {
      const container = document.getElementById('user-fields-container');
      if (!container) return;
      
      if (role === 'siswa') {
        container.innerHTML = `
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Kelas *</label>
            <select id="user-kelas" class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="X IPA 1">X IPA 1</option>
              <option value="X IPA 2">X IPA 2</option>
              <option value="XI IPA 1">XI IPA 1</option>
              <option value="XI IPA 2">XI IPA 2</option>
              <option value="XII IPA 1">XII IPA 1</option>
              <option value="XII IPA 2">XII IPA 2</option>
              <option value="X IPS 1">X IPS 1</option>
              <option value="X IPS 2">X IPS 2</option>
              <option value="XI IPS 1">XI IPS 1</option>
              <option value="XI IPS 2">XI IPS 2</option>
              <option value="XII IPS 1">XII IPS 1</option>
              <option value="XII IPS 2">XII IPS 2</option>
            </select>
          </div>
        `;
      } else if (role === 'guru') {
        container.innerHTML = `
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">Mata Pelajaran *</label>
            <input type="text" id="user-mapel" placeholder="Mata pelajaran yang diampu"
              class="w-full px-4 py-2 border border-slate-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        `;
      } else {
        container.innerHTML = '';
      }
    }

    async function saveNewUser() {
      const name = document.getElementById('user-name').value.trim();
      const username = document.getElementById('user-username').value.trim();
      const password = document.getElementById('user-password').value;
      const role = document.getElementById('user-role').value;
      const nisnip = document.getElementById('user-nisnip').value.trim();

      if (!name || !username || !password || !nisnip) {
        showToast('Harap isi semua field yang wajib!', 'error');
        return;
      }

      if (!validateInput(username, 'username')) {
        showToast('Username harus 3-20 karakter (huruf, angka, underscore)', 'error');
        return;
      }

      if (!validateInput(password, 'password')) {
        showToast('Password minimal 6 karakter', 'error');
        return;
      }

      let kelasMapel = '';
      if (role === 'siswa') {
        kelasMapel = document.getElementById('user-kelas').value;
      } else if (role === 'guru') {
        kelasMapel = document.getElementById('user-mapel').value.trim();
        if (!kelasMapel) {
          showToast('Mata pelajaran wajib untuk guru!', 'error');
          return;
        }
      }

      // Cek duplikasi username
      const existingUser = DATA.users.find(u => u.Username.toLowerCase() === username.toLowerCase());
      if (existingUser) {
        showToast('Username sudah digunakan!', 'error');
        return;
      }

      showLoading('Menyimpan user...');

      const userId = generateUUID('USER_');
      const success = await writeToSheet('users', 'append', {
        row: [
          userId,
          name,
          username,
          password,
          role,
          nisnip,
          kelasMapel,
          new Date().toISOString()
        ]
      });

      hideLoading();

      if (success) {
        showToast('User berhasil ditambahkan!');
        await loadAllData();
        navigateTo('users');
      } else {
        showToast('Gagal menambahkan user', 'error');
      }
    }

    function editUser(userId) {
      showToast('Fitur edit user akan segera tersedia', 'info');
    }

    function confirmDeleteUser(userId) {
      deleteConfirmQueue[userId] = true;
      renderApp();
    }

    function cancelDeleteUser(userId) {
      delete deleteConfirmQueue[userId];
      renderApp();
    }

    async function deleteUser(userId) {
      if (!confirm('Hapus user ini? Semua data terkait juga akan dihapus.')) return;
      
      showLoading('Menghapus user...');
      const success = await writeToSheet('users', 'delete', { id: userId });
      
      if (success) {
        showToast('User berhasil dihapus!');
        delete deleteConfirmQueue[userId];
        await loadAllData();
        renderApp();
      } else {
        showToast('Gagal menghapus user', 'error');
      }
      hideLoading();
    }

    // ==================== HASIL UJIAN ====================
    function renderResultsContent() {
      if (currentUser.role === 'siswa') {
        return renderStudentResults();
      } else {
        return renderTeacherResults();
      }
    }

    function renderStudentResults() {
      const myResults = DATA.results.filter(r => r.StudentID === currentUser.id);
      
      return `
        <div class="fade-in">
          <div class="mb-6">
            <h2 class="text-2xl font-bold dark:text-white">Hasil Ujian Saya</h2>
            <p class="text-slate-500 dark:text-slate-300">${myResults.length} ujian selesai</p>
          </div>
          
          ${myResults.length ? `
            <div class="grid gap-4">
              ${myResults.map(result => {
                const exam = DATA.exams.find(e => e.ID === result.ExamID);
                const score = parseFloat(result.Nilai || 0);
                const scoreColor = score >= 80 ? CONFIG.accent_color : score >= 60 ? '#f59e0b' : '#ef4444';
                const scoreText = score >= 80 ? 'Sangat Baik' : score >= 60 ? 'Baik' : 'Perlu Perbaikan';
                
                return `
                  <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm card-hover transition-all duration-300">
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                          ${getStatusBadge(result.Status)}
                          <span class="px-2 py-1 text-xs rounded-full" style="background: ${scoreColor}20; color: ${scoreColor};">
                            ${scoreText}
                          </span>
                        </div>
                        <h3 class="font-semibold text-lg dark:text-white">${exam?.Judul || 'Ujian'}</h3>
                        <p class="text-slate-500 dark:text-slate-300 text-sm mt-1">
                          ${exam?.Mapel || ''} ‚Ä¢ ${formatDate(result.TanggalSubmit)}
                        </p>
                        <div class="flex gap-4 mt-3 text-sm text-slate-600 dark:text-slate-300">
                          <span>Soal: ${result.TotalSoal || '0'}</span>
                          <span>Benar: ${result.BenarCount || '0'}</span>
                          <span>Salah: ${(result.TotalSoal || 0) - (result.BenarCount || 0)}</span>
                        </div>
                      </div>
                      <div class="text-center ml-4">
                        <div class="w-20 h-20 rounded-full flex items-center justify-center text-2xl font-bold text-white" 
                          style="background: ${scoreColor};">
                          ${score}
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-300 mt-2">Nilai Akhir</p>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : `
            <div class="bg-white dark:bg-gray-700 rounded-xl p-12 text-center shadow-sm">
              <div class="text-6xl mb-4">üìä</div>
              <h3 class="text-xl font-semibold dark:text-white">Belum Ada Hasil</h3>
              <p class="text-slate-500 dark:text-slate-300 mt-2">Anda belum menyelesaikan ujian apapun.</p>
            </div>
          `}
        </div>
      `;
    }

    function renderTeacherResults() {
      const myExams = currentUser.role === 'admin' ? DATA.exams : DATA.exams.filter(e => e.CreatedBy === currentUser.id);
      const relevantResults = DATA.results.filter(r => myExams.some(e => e.ID === r.ExamID));
      
      return `
        <div class="fade-in">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold dark:text-white">Hasil & Nilai</h2>
              <p class="text-slate-500 dark:text-slate-300">${relevantResults.length} hasil ujian</p>
            </div>
            <button onclick="exportResultsData()"
              class="px-4 py-2 bg-green-100 text-green-700 font-medium rounded-xl hover:bg-green-200">
              üìä Export Nilai
            </button>
          </div>
          
          <div class="bg-white dark:bg-gray-700 rounded-xl shadow-sm overflow-hidden">
            <table class="w-full">
              <thead class="bg-slate-50 dark:bg-gray-600 border-b">
                <tr>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Siswa</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Ujian</th>
                  <th class="text-center py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Hasil</th>
                  <th class="text-center py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Nilai</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Status</th>
                  <th class="text-left py-4 px-6 font-semibold text-slate-600 dark:text-white text-sm">Waktu</th>
                </tr>
              </thead>
              <tbody>
                ${relevantResults.map(result => {
                  const student = DATA.users.find(u => u.ID === result.StudentID);
                  const exam = DATA.exams.find(e => e.ID === result.ExamID);
                  const score = parseFloat(result.Nilai || 0);
                  
                  return `
                    <tr class="border-b dark:border-gray-600 hover:bg-slate-50 dark:hover:bg-gray-600">
                      <td class="py-4 px-6">
                        <p class="font-medium dark:text-white">${student?.Nama || result.StudentID}</p>
                        <p class="text-xs text-slate-400">${student?.['Kelas/Mapel'] || ''}</p>
                      </td>
                      <td class="py-4 px-6 text-slate-600 dark:text-slate-300">${exam?.Judul || result.ExamID}</td>
                      <td class="py-4 px-6 text-center text-slate-600 dark:text-slate-300">
                        ${result.BenarCount || '0'}/${result.TotalSoal || '0'}
                      </td>
                      <td class="py-4 px-6 text-center">
                        <span class="px-3 py-1 rounded-full font-bold text-white text-sm"
                          style="background: ${score >= 80 ? CONFIG.accent_color : score >= 60 ? '#f59e0b' : '#ef4444'};">
                          ${score}
                        </span>
                      </td>
                      <td class="py-4 px-6">${getStatusBadge(result.Status)}</td>
                      <td class="py-4 px-6 text-slate-500 dark:text-slate-300 text-sm">
                        ${formatDate(result.TanggalSubmit)}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
            ${relevantResults.length === 0 ? `
              <div class="p-12 text-center">
                <p class="text-slate-400">Belum ada hasil ujian</p>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // ==================== UJIAN (SISWA) ====================
    function startExam(examId) {
      const exam = DATA.exams.find(e => e.ID === examId);
      if (!exam) {
        showToast('Ujian tidak ditemukan', 'error');
        return;
      }

      // Cek apakah sudah pernah mengerjakan
      const existingResult = DATA.results.find(r => 
        r.StudentID === currentUser.id && r.ExamID === examId
      );
      
      if (existingResult) {
        if (confirm('Anda sudah mengerjakan ujian ini. Mulai lagi?')) {
          // Reset existing result
          // (Dalam implementasi nyata, Anda mungkin ingin menghapus result lama)
        } else {
          return;
        }
      }

      const examQuestions = DATA.questions.filter(q => q.ExamID === examId);
      if (examQuestions.length === 0) {
        showToast('Ujian belum memiliki soal', 'error');
        return;
      }

      currentExam = { 
        ...exam, 
        questions: examQuestions.sort(() => Math.random() - 0.5) // Acak soal
      };
      examAnswers = {};
      examTimeLeft = parseInt(exam.Durasi || 120) * 60;
      currentSubView = 'take-exam';
      currentQuestionIndex = 0;
      batchSubmittedCount = 0;
      submittedBatches.clear();
      
      renderApp();
      startExamTimer();
    }

    function startExamTimer() {
      if (examTimer) clearInterval(examTimer);
      examTimer = setInterval(() => {
        examTimeLeft--;
        updateTimerDisplay();
        if (examTimeLeft <= 0) {
          clearInterval(examTimer);
          submitExamAuto();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerEl = document.getElementById('exam-timer');
      if (timerEl) {
        const minutes = Math.floor(examTimeLeft / 60);
        const seconds = examTimeLeft % 60;
        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        if (examTimeLeft <= 300) { // 5 menit terakhir
          timerEl.style.color = '#ef4444';
        }
      }
    }

    function renderTakeExam() {
      if (!currentExam) {
        navigateTo('exams');
        return '';
      }
      
      const questions = currentExam.questions || [];
      const BATCH_SIZE = 5;
      const currentBatchNum = Math.floor(currentQuestionIndex / BATCH_SIZE) + 1;
      const totalBatches = Math.ceil(questions.length / BATCH_SIZE);
      const currentQuestion = questions[currentQuestionIndex];
      
      if (!currentQuestion) {
        submitFinalExam();
        return '';
      }
      
      const isLastQuestionInBatch = (currentQuestionIndex + 1) % BATCH_SIZE === 0;
      const isLastQuestion = currentQuestionIndex === questions.length - 1;
      const currentBatchIndex = Math.floor(currentQuestionIndex / BATCH_SIZE);
      const isBatchSubmitted = submittedBatches.has(currentBatchIndex);
      
      return `
        <div class="h-full w-full flex flex-col bg-white dark:bg-gray-800">
          <!-- Top Header -->
          <div class="border-b dark:border-gray-600 px-6 py-4 flex items-center justify-between">
            <div>
              <h2 class="text-lg font-bold dark:text-white">${currentExam.Judul}</h2>
              <p class="text-xs text-slate-500 dark:text-slate-300">
                Bagian ${currentBatchNum} dari ${totalBatches} ‚Ä¢ ${currentExam.Mapel}
              </p>
            </div>
            <div class="text-center">
              <p class="text-xs text-slate-500 dark:text-slate-300">Sisa Waktu</p>
              <p id="exam-timer" class="text-2xl font-bold font-mono" 
                style="color: ${examTimeLeft <= 300 ? '#ef4444' : CONFIG.primary_color};">
                ${formatTime(examTimeLeft)}
              </p>
            </div>
          </div>
          
          <!-- Question Counter & Navigation -->
          <div class="bg-slate-50 dark:bg-gray-700 px-6 py-3 border-b dark:border-gray-600 flex items-center justify-between">
            <span class="font-medium text-slate-700 dark:text-white">
              Soal ${currentQuestionIndex + 1} dari ${questions.length}
            </span>
            <div class="flex items-center gap-4">
              <!-- Batch Indicators -->
              <div class="flex gap-1">
                ${Array.from({length: totalBatches}).map((_, i) => `
                  <div class="w-2 h-2 rounded-full ${i < currentBatchNum ? 
                    (submittedBatches.has(i) ? 'bg-green-500' : 'bg-blue-500') : 
                    'bg-slate-300'}"></div>
                `).join('')}
              </div>
              <div class="text-sm text-slate-600 dark:text-slate-300">
                ${batchSubmittedCount}/${totalBatches} bagian tersimpan
              </div>
            </div>
          </div>
          
          <!-- Question Navigation Dots -->
          <div class="px-6 py-3 border-b dark:border-gray-600 overflow-x-auto">
            <div class="flex gap-2">
              ${questions.map((q, index) => {
                const isCurrent = index === currentQuestionIndex;
                const isAnswered = examAnswers[q.ID] !== undefined;
                const batchNum = Math.floor(index / BATCH_SIZE);
                const isBatchSubmitted = submittedBatches.has(batchNum);
                
                return `
                  <button onclick="goToQuestion(${index})" 
                    class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition
                    ${isCurrent ? 'bg-blue-500 text-white' : 
                      isAnswered ? 'bg-green-100 text-green-700' : 
                      'bg-slate-100 text-slate-600'} 
                    ${isBatchSubmitted && !isCurrent ? 'opacity-50 cursor-not-allowed' : 'hover:opacity-80'}"
                    ${isBatchSubmitted && !isCurrent ? 'disabled' : ''}>
                    ${index + 1}
                  </button>
                `;
              }).join('')}
            </div>
          </div>
          
          <!-- Main Question Area -->
          <div class="flex-1 overflow-y-auto p-6">
            <div class="max-w-3xl mx-auto">
              <!-- Question Header -->
              <div class="flex items-center gap-4 mb-6">
                <div class="w-14 h-14 rounded-xl flex items-center justify-center font-bold text-lg text-white flex-shrink-0" 
                  style="background: ${CONFIG.primary_color};">
                  ${currentQuestionIndex + 1}
                </div>
                <div class="flex items-center gap-3">
                  <span class="px-3 py-1 text-xs rounded-full font-medium 
                    ${currentQuestion.Tipe === 'pilihan_ganda' ? 
                      'bg-blue-100 text-blue-700' : 
                      'bg-purple-100 text-purple-700'}">
                    ${currentQuestion.Tipe === 'pilihan_ganda' ? 'Pilihan Ganda' : 'Essay'}
                  </span>
                  <span class="text-sm text-slate-500 dark:text-slate-300">
                    ${currentQuestion.Poin || 0} poin
                  </span>
                </div>
              </div>
              
              <!-- Question Text -->
              <div class="bg-slate-50 dark:bg-gray-700 rounded-xl p-6 mb-8">
                <p class="text-lg font-semibold leading-relaxed dark:text-white">
                  ${currentQuestion.Pertanyaan}
                </p>
              </div>
              
              <!-- Answer Area -->
              ${currentQuestion.Tipe === 'pilihan_ganda' ? `
                <div class="space-y-3">
                  ${[currentQuestion.OpsiA, currentQuestion.OpsiB, currentQuestion.OpsiC, currentQuestion.OpsiD]
                    .map((opt, i) => {
                      const isSelected = examAnswers[currentQuestion.ID] === i;
                      return `
                        <label class="flex items-center gap-4 p-5 rounded-xl cursor-pointer transition border-2
                          ${isSelected ? 
                            'border-blue-500 bg-blue-50 dark:bg-blue-900/20 dark:border-blue-400' : 
                            'border-slate-200 dark:border-gray-600 hover:border-slate-300 dark:hover:border-gray-500 bg-white dark:bg-gray-700'}">
                          <input type="radio" name="question-${currentQuestion.ID}" value="${i}" 
                            ${isSelected ? 'checked' : ''}
                            onchange="selectAnswer('${currentQuestion.ID}', ${i})"
                            class="w-6 h-6 cursor-pointer">
                          <div class="flex-1">
                            <span class="font-bold mr-3 text-lg dark:text-white">
                              ${String.fromCharCode(65 + i)}.
                            </span>
                            <span class="text-base dark:text-white">${opt || '-'}</span>
                          </div>
                        </label>
                      `;
                    }).join('')}
                </div>
              ` : `
                <div>
                  <label class="block text-sm font-medium text-slate-700 dark:text-white mb-2">
                    Jawaban Essay
                  </label>
                  <textarea 
                    placeholder="Tulis jawaban Anda di sini..."
                    rows="8"
                    oninput="saveEssayAnswer('${currentQuestion.ID}', this.value)"
                    class="w-full p-6 border-2 border-slate-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base resize-none">${examAnswers[currentQuestion.ID] || ''}</textarea>
                </div>
              `}
            </div>
          </div>
          
          <!-- Bottom Navigation -->
          <div class="bg-white dark:bg-gray-700 border-t dark:border-gray-600 px-6 py-4 flex items-center justify-between">
            <button onclick="previousQuestion()"
              class="px-6 py-3 rounded-xl font-medium transition 
              ${currentQuestionIndex === 0 || 
                (currentBatchIndex > 0 && submittedBatches.has(currentBatchIndex - 1)) ? 
                'bg-slate-100 dark:bg-gray-600 text-slate-400 cursor-not-allowed' : 
                'bg-slate-100 dark:bg-gray-600 text-slate-700 dark:text-white hover:bg-slate-200 dark:hover:bg-gray-500'}"
              ${currentQuestionIndex === 0 || 
                (currentBatchIndex > 0 && submittedBatches.has(currentBatchIndex - 1)) ? 'disabled' : ''}>
              ‚Üê Sebelumnya
            </button>
            
            <div class="text-sm text-slate-600 dark:text-slate-300">
              <span class="font-semibold">${currentQuestionIndex + 1}</span> / 
              <span>${questions.length}</span>
            </div>
            
            ${isLastQuestion ? `
              <button onclick="confirmSubmitFinalExam()"
                class="px-6 py-3 text-white font-semibold rounded-xl btn-primary shadow-md"
                style="background: ${CONFIG.accent_color};">
                ‚úÖ Selesai & Kumpulkan
              </button>
            ` : isLastQuestionInBatch ? `
              <button onclick="confirmBatchSubmission()"
                class="px-6 py-3 text-white font-semibold rounded-xl btn-primary shadow-md"
                style="background: ${CONFIG.secondary_color};">
                üíæ Simpan Bagian & Lanjut ‚Üí
              </button>
            ` : `
              <button onclick="nextQuestion()"
                class="px-6 py-3 text-white font-semibold rounded-xl btn-primary shadow-md"
                style="background: ${CONFIG.secondary_color};">
                Selanjutnya ‚Üí
              </button>
            `}
          </div>
        </div>
      `;
    }

    function goToQuestion(index) {
      const BATCH_SIZE = 5;
      const currentBatchIndex = Math.floor(currentQuestionIndex / BATCH_SIZE);
      const targetBatchIndex = Math.floor(index / BATCH_SIZE);
      
      // Cek apakah bisa navigasi ke soal tersebut
      if (targetBatchIndex < currentBatchIndex && submittedBatches.has(targetBatchIndex)) {
        showToast('Tidak bisa kembali ke bagian yang sudah disimpan', 'warning');
        return;
      }
      
      currentQuestionIndex = index;
      renderApp();
    }

    function previousQuestion() {
      const BATCH_SIZE = 5;
      const currentBatchIndex = Math.floor(currentQuestionIndex / BATCH_SIZE);
      const batchStart = currentBatchIndex * BATCH_SIZE;
      
      if (currentQuestionIndex > batchStart) {
        currentQuestionIndex--;
        renderApp();
      }
    }

    function nextQuestion() {
      const BATCH_SIZE = 5;
      const questions = currentExam?.questions || [];
      const currentBatchIndex = Math.floor(currentQuestionIndex / BATCH_SIZE);
      const batchEnd = Math.min((currentBatchIndex + 1) * BATCH_SIZE, questions.length);
      
      if (currentQuestionIndex < batchEnd - 1) {
        currentQuestionIndex++;
        renderApp();
      }
    }

    function selectAnswer(questionId, optionIndex) {
      examAnswers[questionId] = optionIndex;
    }

    function saveEssayAnswer(questionId, value) {
      if (value.trim()) {
        examAnswers[questionId] = value;
      } else {
        delete examAnswers[questionId];
      }
    }

    function confirmBatchSubmission() {
      const BATCH_SIZE = 5;
      const currentBatchNum = Math.floor(currentQuestionIndex / BATCH_SIZE) + 1;
      const totalBatches = Math.ceil((currentExam?.questions || []).length / BATCH_SIZE);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="modal-content bg-white dark:bg-gray-700 rounded-2xl shadow-2xl max-w-md w-full p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl" 
              style="background: ${CONFIG.accent_color}20; color: ${CONFIG.accent_color};">
              ‚ö†Ô∏è
            </div>
            <div>
              <h3 class="text-lg font-bold dark:text-white">Simpan Bagian ${currentBatchNum}?</h3>
              <p class="text-sm text-slate-500 dark:text-slate-300">Bagian ${currentBatchNum} dari ${totalBatches}</p>
            </div>
          </div>
          
          <p class="text-slate-600 dark:text-slate-300 mb-4">
            Setelah Anda menyimpan bagian ini, Anda <strong>tidak dapat kembali</strong> untuk mengubah jawaban di bagian ini lagi.
          </p>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg p-3 mb-6">
            <p class="text-sm text-blue-700 dark:text-blue-300">
              üí° <strong>Saran:</strong> Periksa kembali jawaban Anda sebelum melanjutkan.
            </p>
          </div>
          
          <div class="flex gap-3 justify-end">
            <button onclick="closeModal()"
              class="px-4 py-2 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-500 transition font-medium">
              Kembali Cek
            </button>
            <button onclick="submitBatch()"
              class="px-4 py-2 text-white rounded-lg btn-primary shadow-md font-medium"
              style="background: ${CONFIG.accent_color};">
              Simpan & Lanjut
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function submitBatch() {
      closeModal();
      
      const BATCH_SIZE = 5;
      const questions = currentExam?.questions || [];
      const batchStart = Math.floor(currentQuestionIndex / BATCH_SIZE) * BATCH_SIZE;
      const batchEnd = Math.min(batchStart + BATCH_SIZE, questions.length);
      const currentBatchIndex = Math.floor(currentQuestionIndex / BATCH_SIZE);
      const batchQuestions = questions.slice(batchStart, batchEnd);
      
      showLoading('Menyimpan jawaban...');
      
      try {
        // Save answers to Google Sheets
        for (const q of batchQuestions) {
          if (examAnswers[q.ID] !== undefined) {
            const answerId = generateUUID('ANS_');
            await writeToSheet('answers', 'append', {
              row: [
                answerId,
                currentUser.id,
                currentExam.ID,
                q.ID,
                examAnswers[q.ID],
                new Date().toISOString(),
                'batch_submitted'
              ]
            });
          }
        }
        
        batchSubmittedCount++;
        submittedBatches.add(currentBatchIndex);
        
        // Move to next question if available
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
        }
        
        await loadAllData();
        showToast(`Bagian ${currentBatchIndex + 1} berhasil disimpan!`, 'success');
        renderApp();
      } catch (error) {
        console.error('Error submitting batch:', error);
        showToast('Gagal menyimpan bagian', 'error');
      } finally {
        hideLoading();
      }
    }

    function confirmSubmitFinalExam() {
      const questions = currentExam?.questions || [];
      const answeredCount = Object.keys(examAnswers).length;
      const BATCH_SIZE = 5;
      const totalBatches = Math.ceil(questions.length / BATCH_SIZE);
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="modal-content bg-white dark:bg-gray-700 rounded-2xl shadow-2xl max-w-md w-full p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl" 
              style="background: ${CONFIG.accent_color}20; color: ${CONFIG.accent_color};">
              ‚úÖ
            </div>
            <div>
              <h3 class="text-lg font-bold dark:text-white">Kumpulkan Ujian?</h3>
              <p class="text-sm text-slate-500 dark:text-slate-300">
                ${batchSubmittedCount}/${totalBatches} bagian tersimpan
              </p>
            </div>
          </div>
          
          <div class="space-y-3 mb-6">
            <div class="flex justify-between text-sm">
              <span class="text-slate-600 dark:text-slate-300">Total Soal:</span>
              <span class="font-medium">${questions.length}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600 dark:text-slate-300">Terjawab:</span>
              <span class="font-medium ${answeredCount < questions.length ? 'text-yellow-600' : 'text-green-600'}">
                ${answeredCount}/${questions.length}
              </span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-slate-600 dark:text-slate-300">Sisa Waktu:</span>
              <span class="font-medium">${formatTime(examTimeLeft)}</span>
            </div>
          </div>
          
          ${answeredCount < questions.length ? `
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-3 mb-6">
              <p class="text-sm text-yellow-700 dark:text-yellow-300">
                ‚ö†Ô∏è <strong>Perhatian:</strong> Masih ada ${questions.length - answeredCount} soal yang belum dijawab.
              </p>
            </div>
          ` : ''}
          
          <p class="text-sm text-slate-500 dark:text-slate-300 mb-6">
            Setelah dikumpulkan, Anda tidak dapat mengubah jawaban lagi.
          </p>
          
          <div class="flex gap-3 justify-end">
            <button onclick="closeModal()"
              class="px-4 py-2 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-500 transition font-medium">
              Lanjutkan Ujian
            </button>
            <button onclick="submitFinalExam()"
              class="px-4 py-2 text-white rounded-lg btn-primary shadow-md font-medium"
              style="background: ${CONFIG.accent_color};">
              Kumpulkan Sekarang
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function submitFinalExam() {
      closeModal();
      
      if (isSubmittingExam) return;
      isSubmittingExam = true;
      
      if (examTimer) clearInterval(examTimer);
      showLoading('Mengirim jawaban dan menghitung nilai...');
      
      try {
        const questions = currentExam?.questions || [];
        
        // Submit any remaining answers
        const BATCH_SIZE = 5;
        const batchStart = Math.floor(currentQuestionIndex / BATCH_SIZE) * BATCH_SIZE;
        const remainingQuestions = questions.slice(batchStart);
        
        for (const q of remainingQuestions) {
          if (examAnswers[q.ID] !== undefined) {
            const answerId = generateUUID('ANS_');
            await writeToSheet('answers', 'append', {
              row: [
                answerId,
                currentUser.id,
                currentExam.ID,
                q.ID,
                examAnswers[q.ID],
                new Date().toISOString(),
                'final_submitted'
              ]
            });
          }
        }
        
        // Calculate score
        let correctCount = 0;
        let totalPoints = 0;
        let earnedPoints = 0;
        
        questions.forEach(q => {
          totalPoints += parseInt(q.Poin || 0);
          if (q.Tipe === 'pilihan_ganda' && examAnswers[q.ID] != null) {
            if (parseInt(examAnswers[q.ID]) === parseInt(q.JawabanBenar || 0)) {
              correctCount++;
              earnedPoints += parseInt(q.Poin || 0);
            }
          }
        });
        
        const score = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
        
        // Save result
        const resultId = generateUUID('RES_');
        await writeToSheet('results', 'append', {
          row: [
            resultId,
            currentUser.id,
            currentExam.ID,
            score,
            correctCount,
            questions.length,
            new Date().toISOString(),
            'completed'
          ]
        });
        
        await loadAllData();
        hideLoading();
        showExamCompletedModal(score, correctCount, questions.length);
        
      } catch (error) {
        console.error('Error submitting exam:', error);
        hideLoading();
        showToast('Terjadi kesalahan saat mengirim ujian', 'error');
      } finally {
        isSubmittingExam = false;
      }
    }

    function submitExamAuto() {
      if (confirm('Waktu ujian telah habis! Kumpulkan ujian sekarang?')) {
        submitFinalExam();
      }
    }

    function showExamCompletedModal(score, correct, total) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="modal-content bg-white dark:bg-gray-700 rounded-2xl shadow-2xl max-w-md w-full p-8 text-center fade-in">
          <div class="w-24 h-24 mx-auto rounded-full flex items-center justify-center text-4xl font-bold text-white mb-4"
            style="background: ${score >= 80 ? CONFIG.accent_color : score >= 60 ? '#f59e0b' : '#ef4444'};">
            ${score}
          </div>
          
          <h3 class="text-2xl font-bold mb-2 dark:text-white">Ujian Selesai!</h3>
          <p class="text-slate-500 dark:text-slate-300 mb-6">
            ${currentExam?.Judul || 'Ujian'} telah dikumpulkan
          </p>
          
          <div class="bg-slate-50 dark:bg-gray-600 rounded-xl p-6 mb-6">
            <div class="grid grid-cols-3 gap-4">
              <div>
                <p class="text-2xl font-bold" style="color: ${CONFIG.primary_color};">${correct}</p>
                <p class="text-sm text-slate-500 dark:text-slate-300">Benar</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-slate-400">${total - correct}</p>
                <p class="text-sm text-slate-500 dark:text-slate-300">Salah</p>
              </div>
              <div>
                <p class="text-2xl font-bold" style="color: ${CONFIG.secondary_color};">${total}</p>
                <p class="text-sm text-slate-500 dark:text-slate-300">Total</p>
              </div>
            </div>
            
            <div class="mt-4 pt-4 border-t dark:border-gray-500">
              <p class="text-sm text-slate-600 dark:text-slate-300">
                ${score >= 80 ? 'üéâ Excellent!' : 
                  score >= 60 ? 'üëç Good job!' : 
                  'üìö Keep practicing!'}
              </p>
            </div>
          </div>
          
          <div class="space-y-3">
            <button onclick="closeExamCompletedModal()"
              class="w-full py-3 text-white font-semibold rounded-xl transition hover:opacity-90"
              style="background: ${CONFIG.primary_color};">
              Kembali ke Dashboard
            </button>
            <button onclick="viewExamResult('${currentExam?.ID}')"
              class="w-full py-3 text-slate-700 dark:text-white bg-slate-100 dark:bg-gray-600 rounded-xl hover:bg-slate-200 dark:hover:bg-gray-500 transition">
              Lihat Detail Hasil
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeExamCompletedModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
      
      // Reset exam state
      currentExam = null;
      examAnswers = {};
      batchSubmittedCount = 0;
      currentQuestionIndex = 0;
      submittedBatches.clear();
      
      // Navigate back
      navigateTo('results');
    }

    function viewExamResult(examId) {
      closeModal();
      navigateTo('results');
      // Dalam implementasi lengkap, bisa menampilkan detail hasil
    }

    // ==================== EXPORT FUNCTIONS ====================
    function exportAllData() {
      const dataToExport = {
        sekolah: CONFIG.school_name,
        tahun_ajaran: CONFIG.school_year,
        timestamp: new Date().toISOString(),
        users: DATA.users,
        exams: DATA.exams,
        questions: DATA.questions,
        results: DATA.results,
        answers: DATA.answers
      };
      
      const wb = XLSX.utils.book_new();
      
      // Export users
      const wsUsers = XLSX.utils.json_to_sheet(DATA.users);
      XLSX.utils.book_append_sheet(wb, wsUsers, "Users");
      
      // Export exams
      const wsExams = XLSX.utils.json_to_sheet(DATA.exams);
      XLSX.utils.book_append_sheet(wb, wsExams, "Exams");
      
      // Export questions
      const wsQuestions = XLSX.utils.json_to_sheet(DATA.questions);
      XLSX.utils.book_append_sheet(wb, wsQuestions, "Questions");
      
      // Export results
      const wsResults = XLSX.utils.json_to_sheet(DATA.results);
      XLSX.utils.book_append_sheet(wb, wsResults, "Results");
      
      const filename = `cbt_backup_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, filename);
      showToast('Data berhasil diexport!', 'success');
    }

    function exportExamData() {
      const examsToExport = DATA.exams.map(exam => ({
        'Judul': exam.Judul,
        'Mata Pelajaran': exam.Mapel,
        'Kelas': exam.Kelas,
        'Tanggal': exam.Tanggal,
        'Waktu': exam.Waktu,
        'Durasi': exam.Durasi,
        'Status': exam.Status,
        'Total Soal': DATA.questions.filter(q => q.ExamID === exam.ID).length
      }));
      
      const ws = XLSX.utils.json_to_sheet(examsToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Exams");
      XLSX.writeFile(wb, `data_ujian_${new Date().toISOString().slice(0,10)}.xlsx`);
      showToast('Data ujian berhasil diexport!', 'success');
    }

    function exportQuestions(examId) {
      const questions = DATA.questions.filter(q => q.ExamID === examId);
      const exam = DATA.exams.find(e => e.ID === examId);
      
      const questionsToExport = questions.map((q, index) => ({
        'No': index + 1,
        'Pertanyaan': q.Pertanyaan,
        'Tipe': q.Tipe === 'pilihan_ganda' ? 'Pilihan Ganda' : 'Essay',
        'Opsi A': q.OpsiA || '',
        'Opsi B': q.OpsiB || '',
        'Opsi C': q.OpsiC || '',
        'Opsi D': q.OpsiD || '',
        'Jawaban Benar': q.Tipe === 'pilihan_ganda' ? String.fromCharCode(65 + parseInt(q.JawabanBenar || 0)) : '',
        'Poin': q.Poin || 0
      }));
      
      const ws = XLSX.utils.json_to_sheet(questionsToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Questions");
      XLSX.writeFile(wb, `soal_${exam?.Judul?.replace(/[^a-z0-9]/gi, '_') || 'ujian'}_${new Date().toISOString().slice(0,10)}.xlsx`);
      showToast('Soal berhasil diexport!', 'success');
    }

    function exportResultsData() {
      const resultsToExport = DATA.results.map(result => {
        const student = DATA.users.find(u => u.ID === result.StudentID);
        const exam = DATA.exams.find(e => e.ID === result.ExamID);
        
        return {
          'Nama Siswa': student?.Nama || '',
          'Kelas': student?.['Kelas/Mapel'] || '',
          'Ujian': exam?.Judul || '',
          'Mata Pelajaran': exam?.Mapel || '',
          'Nilai': result.Nilai || 0,
          'Benar': result.BenarCount || 0,
          'Total Soal': result.TotalSoal || 0,
          'Tanggal Submit': result.TanggalSubmit || '',
          'Status': result.Status || ''
        };
      });
      
      const ws = XLSX.utils.json_to_sheet(resultsToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Results");
      XLSX.writeFile(wb, `hasil_ujian_${new Date().toISOString().slice(0,10)}.xlsx`);
      showToast('Hasil ujian berhasil diexport!', 'success');
    }

    // ==================== DARK MODE ====================
    function toggleDarkMode() {
      const html = document.documentElement;
      html.classList.toggle('dark');
      localStorage.setItem('darkMode', html.classList.contains('dark'));
      showToast(html.classList.contains('dark') ? 'Mode gelap diaktifkan' : 'Mode terang diaktifkan', 'info');
    }

    // ==================== INITIALIZATION ====================
    function initializeApp() {
      // Cek dark mode
      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
      }
      
      // Cek auth
      if (!checkAuth()) {
        currentView = 'login';
      }
      
      // Load initial data
      loadAllData();
      
      // Setup beforeunload warning for exam
      window.addEventListener('beforeunload', (e) => {
        if (currentSubView === 'take-exam') {
          e.preventDefault();
          e.returnValue = 'Ujian masih berlangsung. Yakin ingin keluar?';
        }
      });
      
      renderApp();
    }

    // ==================== APP START ====================
    initializeApp();
  </script>
</body>
</html>

